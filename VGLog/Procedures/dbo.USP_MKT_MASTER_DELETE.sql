USE [VGLog]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[USP_MKT_MASTER_DELETE]

/*
USP_MKT_MASTER_DELETE '2014-03-26'

2017-07-14 PRO_TYPE 추가 
*/

@TARGET_DATE VARCHAR(10),
@PRO_TYPE VARCHAR(10)

AS

DECLARE @CNT INT;
DECLARE @RET VARCHAR(10);

SET @CNT = 0;
SELECT @TARGET_DATE = CONVERT(VARCHAR(10), MAX(EDT_DATE), 121) FROM MKT_MASTER

SELECT @CNT = COUNT(*) FROM MKT_MASTER WHERE EDT_DATE > @TARGET_DATE AND PRO_TYPE = @PRO_TYPE 

PRINT(@TARGET_DATE)
PRINT(@CNT)

--IF (@CNT < 50000) RETURN;

SET @RET = 'SUCCESS'

INSERT INTO MKT_MASTER_DEL 
(PRO_CODE, PRO_TYPE, PRO_NAME, MIN_PRICE, PRO_URL, IMG_URL, CATE1, CATE2, CATE3, CATE4, CATE_DESC1, CATE_DESC2, CATE_DESC3, CATE_DESC4, 
BLAND_NAME, EVENT_DESC, CARD_DESC, COUP_DESC, POINT, REGION_CODE, REGION_NAME, NATION_CODE, NATION_NAME, CITY_CODE, CITY_NAME, TEAM_CODE, 
USE_YN, AUTO_UPDATE_YN, NEW_DATE, NEW_CODE, EDT_DATE, EDT_CODE, AFF_CODE)
SELECT PRO_CODE, PRO_TYPE, PRO_NAME, MIN_PRICE, PRO_URL, IMG_URL, CATE1, CATE2, CATE3, CATE4, CATE_DESC1, CATE_DESC2, CATE_DESC3, CATE_DESC4, 
BLAND_NAME, EVENT_DESC, CARD_DESC, COUP_DESC, POINT, REGION_CODE, REGION_NAME, NATION_CODE, NATION_NAME, CITY_CODE, CITY_NAME, TEAM_CODE, 
USE_YN, AUTO_UPDATE_YN, NEW_DATE, NEW_CODE, EDT_DATE, EDT_CODE, AFF_CODE 
FROM MKT_MASTER WHERE EDT_DATE < @TARGET_DATE AND PRO_CODE NOT IN (SELECT PRO_CODE FROM MKT_MASTER_DEL WHERE PRO_TYPE = @PRO_TYPE )
AND PRO_TYPE = @PRO_TYPE 

DELETE MKT_MASTER WHERE EDT_DATE < @TARGET_DATE AND PRO_TYPE= @PRO_TYPE 

SELECT @RET AS RET_MSG
GO
