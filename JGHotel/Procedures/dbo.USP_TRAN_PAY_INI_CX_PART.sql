USE [JGHotel]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[USP_TRAN_PAY_INI_CX_PART]

/*
USP_TRAN_PAY_INI_CX_PART
*/

@P_TID VARCHAR(100), 
@P_STATUS VARCHAR(100), 
@P_TYPE VARCHAR(100),  
@P_AMT DECIMAL, 
@P_PAY_AMT DECIMAL, 
@P_OLD_TID VARCHAR(100)


AS


UPDATE TBL_TRAN_PAY_INI SET 
	P_CX_AMT = (P_CX_AMT + @P_AMT),
	CANCEL_DATE = (CASE WHEN (P_CX_AMT + @P_AMT) >= P_PAY_AMT THEN GETDATE() ELSE NULL END)
WHERE P_TID=@P_OLD_TID


INSERT INTO TBL_TRAN_PAY_INI
(
	P_TID,
	P_STATUS,
	P_TYPE,
	P_AMT,
	P_PAY_AMT,
	P_CX_AMT,
	P_OLD_TID,
	CREATE_DATE
)
VALUES
(
	@P_TID,
	@P_STATUS,
	@P_TYPE,
	@P_AMT,
	@P_PAY_AMT,
	0,
	@P_OLD_TID,
	GETDATE()
)
GO
