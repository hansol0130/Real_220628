USE [JGHotel]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[USP_HTL_IDX_CITY]
      
/*      
USP_HTL_IDX_CITY
*/      
      
AS      

CREATE TABLE #TMP_CITY (
	NATION_CODE VARCHAR(2),
	NATION_NAME VARCHAR(300),
	NATION_ENAME VARCHAR(300),
	CITY_CODE BIGINT,
	CITY_NAME VARCHAR(300),
	CITY_ENAME VARCHAR(300),
	AREA_CODE BIGINT,
	AREA_NAME VARCHAR(300),
	AREA_ENAME VARCHAR(300),
	HOTEL_CODE INT,
	HOTEL_NAME VARCHAR(300),
	HOTEL_ENAME VARCHAR(300),
	INDEX_NAME VARCHAR(500),
	SORT INT,
	HOTEL_CNT INT,
	ITEM_TYPE VARCHAR(1)
);


INSERT #TMP_CITY
SELECT NATION_CODE, NATION_NAME, NATION_ENAME, CITY_CODE, CITY_NAME, CITY_ENAME, 
NULL, NULL, NULL, NULL, NULL, NULL, INDEX_NAME, SORT_ORDER, HOTEL_CNT, 'C'
FROM HTL_CODE_MAST_CITY      
WHERE USE_YN='Y' AND NATION_CODE <> 'KR'


INSERT #TMP_CITY
SELECT B.NATION_CODE, B.NATION_NAME, B.NATION_ENAME, A.CITY_CODE, A.CITY_NAME, B.CITY_ENAME, 
A.AREA_CODE, A.AREA_NAME, A.AREA_ENAME, NULL, NULL, NULL, 
A.AREA_NAME + ',' + A.AREA_ENAME, B.SORT_ORDER,
A.HOTEL_CNT, 'A'
FROM HTL_CODE_MAST_AREA A
JOIN HTL_CODE_MAST_CITY B ON A.CITY_CODE=B.CITY_CODE
WHERE A.USE_YN='Y' AND B.USE_YN='Y' AND B.NATION_CODE <> 'KR'


INSERT #TMP_CITY
SELECT B.NATION_CODE, B.NATION_NAME, B.NATION_ENAME, B.CITY_CODE, B.CITY_NAME, B.CITY_ENAME,
A.AREA_CODE, A.AREA_NAME, C.AREA_ENAME, A.HOTEL_CODE, A.NAME, A.ENG_NAME, 
A.NAME + ',' + A.ENG_NAME, B.SORT_ORDER, A.RV_POINT, 'H'
FROM HTL_INFO_MAST_HOTEL A
JOIN HTL_CODE_MAST_CITY B ON A.CITY_CODE=B.CITY_CODE
LEFT JOIN HTL_CODE_MAST_AREA C ON A.AREA_CODE=C.AREA_CODE
WHERE A.USE_YN='Y' AND B.USE_YN='Y' AND B.NATION_CODE <> 'KR'


--PRINT(CONVERT(VARCHAR, GETDATE(), 121))

DECLARE @CNT INT;
SELECT @CNT = COUNT(*) FROM #TMP_CITY

IF (@CNT > 100000) 
BEGIN 

	INSERT INTO HTL_IDX_CITY
	(
		NATION_CODE,
		NATION_NAME,
		NATION_ENAME,
		CITY_CODE,
		CITY_NAME,
		CITY_ENAME,
		AREA_CODE,
		AREA_NAME,
		AREA_ENAME,
		HOTEL_CODE,
		HOTEL_NAME,
		HOTEL_ENAME,
		INDEX_NAME,
		SORT,
		HOTEL_CNT,
		ITEM_TYPE,
		USE_YN
	)
	SELECT
		NATION_CODE,
		NATION_NAME,
		NATION_ENAME,
		CITY_CODE,
		CITY_NAME,
		CITY_ENAME,
		AREA_CODE,
		AREA_NAME,
		AREA_ENAME,
		HOTEL_CODE,
		HOTEL_NAME,
		HOTEL_ENAME,
		INDEX_NAME,
		SORT,
		HOTEL_CNT,
		ITEM_TYPE,
		'N'
	FROM #TMP_CITY

	UPDATE HTL_IDX_CITY SET USE_YN = (CASE WHEN USE_YN='Y' THEN 'N' ELSE 'Y' END)
	DELETE HTL_IDX_CITY WHERE USE_YN='N'

END

--PRINT(CONVERT(VARCHAR, GETDATE(), 121))

DROP TABLE #TMP_CITY

GO
