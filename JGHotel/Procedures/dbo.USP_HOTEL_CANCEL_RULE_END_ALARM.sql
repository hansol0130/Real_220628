USE [JGHotel]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[USP_HOTEL_CANCEL_RULE_END_ALARM]      
      
/*      
USP_HOTEL_CANCEL_RULE_END_ALARM      
*/      
      
AS      
      
SELECT HOTEL_CODE, MAX(CHECK_IN_DATE) AS CHECK_IN_DATE      
INTO #TMP_TABLE      
FROM HTL_DOM_INFO_PRICE_DIR     
WHERE NET_PRICE > 5000     
GROUP BY HOTEL_CODE      
      
SELECT A.HOTEL_CODE, B.HOTEL_NAME, A.CHECK_IN_DATE, C.RULE_END_DATE      
FROM #TMP_TABLE A      
JOIN HTL_DOM_INFO_HOTEL B ON A.HOTEL_CODE=B.HOTEL_CODE      
JOIN (    
 SELECT HOTEL_CODE, MAX(DATE_TO) AS RULE_END_DATE    
 FROM HTL_DOM_INFO_CXL_MAST    
 WHERE USE_YN='Y'    
 GROUP BY HOTEL_CODE    
) C ON A.HOTEL_CODE=C.HOTEL_CODE    
WHERE B.SUPP_TYPE='JG'      
AND B.USE_YN='Y'    
AND A.CHECK_IN_DATE > C.RULE_END_DATE    
AND ISNULL(B.PRICE_YN,'Y')='Y'  
ORDER BY (CASE WHEN A.HOTEL_CODE IN ('900006','900010','900009','900008','900007') THEN 0 ELSE 1 END),     
RULE_END_DATE    
    
    
    
    
    
GO
