USE [JGHotel]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROC [dbo].[USP_HTL_DOM_PRICE_COPY]

/*
USP_HTL_DOM_PRICE_COPY '900332', '3', '1', 'JACKSMT'
*/

@HOTEL_CODE VARCHAR(10),
@ROOM_CODE_FROM VARCHAR(10),
@ROOM_CODE_TO VARCHAR(10),
@UPDATE_USER VARCHAR(30)

AS

SELECT * 
INTO #PRICE1
FROM HTL_DOM_INFO_PRICE_DIR
WHERE HOTEL_CODE=@HOTEL_CODE AND ROOM_CODE=@ROOM_CODE_FROM

SELECT * 
INTO #PRICE2
FROM HTL_DOM_INFO_PRICE_DIR
WHERE HOTEL_CODE=@HOTEL_CODE AND ROOM_CODE=@ROOM_CODE_TO



UPDATE HTL_DOM_INFO_PRICE_DIR SET
CURRENCY = B.CURRENCY, 
NET_PRICE = B.NET_PRICE, 
SALE_PRICE = B.SALE_PRICE, 
UPDATE_USER = @UPDATE_USER, 
UPDATE_DATE = GETDATE()
--SELECT *
FROM HTL_DOM_INFO_PRICE_DIR A
JOIN (
	SELECT A.HOTEL_CODE, A.ROOM_CODE, A.ROOM_NAME, A.CHECK_IN_DATE, A.CURRENCY, A.NET_PRICE, A.SALE_PRICE, 
	A.AVAIL_TYPE, A.CREATE_USER, A.CREATE_DATE, @UPDATE_USER AS UPDATE_USER, GETDATE() AS UPDATE_DATE
	FROM #PRICE1 A
	JOIN #PRICE2 B ON A.CHECK_IN_DATE=B.CHECK_IN_DATE
) B ON A.HOTEL_CODE=B.HOTEL_CODE AND A.ROOM_CODE=@ROOM_CODE_TO AND A.CHECK_IN_DATE=B.CHECK_IN_DATE


INSERT INTO HTL_DOM_INFO_PRICE_DIR
SELECT A.HOTEL_CODE, @ROOM_CODE_TO, A.ROOM_NAME, A.CHECK_IN_DATE, A.CURRENCY, A.NET_PRICE, A.SALE_PRICE, 
'RQ', @UPDATE_USER, GETDATE(), @UPDATE_USER, GETDATE()
FROM #PRICE1 A
LEFT JOIN #PRICE2 B ON A.CHECK_IN_DATE=B.CHECK_IN_DATE
WHERE B.PRICE_SEQ IS NULL
ORDER BY A.CHECK_IN_DATE

GO
