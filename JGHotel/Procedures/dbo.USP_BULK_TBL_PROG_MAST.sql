USE [JGHotel]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[USP_BULK_TBL_PROG_MAST]

@XML VARCHAR(MAX)

AS

DECLARE @XML_DOCUMENT_HANDLE INT;
DECLARE @XML_DOCUMENT VARCHAR(MAX);
SET @XML_DOCUMENT = '<?xml version="1.0" encoding="euc-kr"?>' + @XML

EXEC SP_XML_PREPAREDOCUMENT @XML_DOCUMENT_HANDLE OUTPUT,  @XML_DOCUMENT

SELECT *
INTO #TMP_TABLE
FROM OPENXML (@XML_DOCUMENT_HANDLE,  '/ArrayOfProgramRQ/ProgramRQ', 2)                 
WITH (  
	GroupId VARCHAR(1000) './GroupId',
	GroupName VARCHAR(1000) './GroupName',
	GroupSort VARCHAR(1000) './GroupSort',
	GroupUseYn VARCHAR(1000) './GroupUseYn',
	ProgId VARCHAR(1000) './ProgId',
	Name VARCHAR(1000) './Name',
	Url VARCHAR(1000) './Url',
	Sort VARCHAR(1000) './Sort',
	UseYn VARCHAR(1000) './UseYn',
	UpdateUser VARCHAR(1000) './UpdateUser'
) A



--GROUP UPDATE
UPDATE TBL_PROG_GROUP SET 
NAME=B.GroupName, SORT=B.GroupSort, USE_YN=B.GroupUseYn, 
UPDATE_USER=B.UpdateUser, UPDATE_DATE=GETDATE()
FROM TBL_PROG_GROUP A
JOIN (
	SELECT GroupId, GroupName, GroupSort, GroupUseYn, UpdateUser
	FROM #TMP_TABLE
	GROUP BY GroupId, GroupName, GroupSort, GroupUseYn, UpdateUser
) B ON A.GROUP_ID=B.GroupId


--MAST UPDATE
UPDATE TBL_PROG_MAST SET 
NAME=B.Name, URL=B.Url, SORT=B.Sort, USE_YN=B.UseYn, GROUP_ID=B.GroupId,
UPDATE_USER=B.UpdateUser, UPDATE_DATE=GETDATE()
FROM TBL_PROG_MAST A
JOIN #TMP_TABLE B ON A.PROG_ID=B.ProgId


EXEC SP_XML_REMOVEDOCUMENT @XML_DOCUMENT_HANDLE 


GO
