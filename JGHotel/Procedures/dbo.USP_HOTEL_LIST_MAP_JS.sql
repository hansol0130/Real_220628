USE [JGHotel]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[USP_HOTEL_LIST_MAP_JS]
   
/*   
USP_HOTEL_LIST_MAP_JS '179900'
*/   
   
@CITY_CODE VARCHAR(20)
   
AS

SELECT RANK() OVER (ORDER BY RECOM_YN DESC, (CASE WHEN RV_POINT > 4 THEN 4 ELSE RV_POINT END) DESC, BOOK_CNT DESC, SALE_AMT, HOTEL_CODE) AS SORT_NUM, *
FROM (
	SELECT
	A.HOTEL_CODE, ENG_NAME, NAME, STAR_RATING, ADDRESS, MAIN_IMG,
	LOCATION_DESC, LATITUDE, LONGITUDE, AREA_CODE, AREA_NAME, ISNULL(SALE_AMT,9999999999) AS SALE_AMT,
	ISNULL((SELECT COUNT(RESV_NO) FROM HTL_RESV_MAST WHERE HOTEL_CODE=CONVERT(VARCHAR,A.HOTEL_CODE) AND HOTEL_CODE NOT LIKE 'OF%'),0) AS BOOK_CNT,
	ISNULL((CASE WHEN SALE_AMT IS NULL THEN 0 ELSE RV_POINT END),0) AS RV_POINT, RECOM_YN
	FROM HTL_INFO_MAST_HOTEL A
	LEFT JOIN HTL_INFO_PRICE B ON A.HOTEL_CODE=B.HOTEL_CODE
	WHERE CITY_CODE=@CITY_CODE
	AND USE_YN='Y'
) A


GO
