USE [JGHotel]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[USP_HTL_CITY_SEARCH]
      
/*      
USP_HTL_CITY_SEARCH '파리'      
*/      
      
@KEYWORD VARCHAR(100)      
      
AS      
      
SELECT TOP 20 CITY_CODE, CITY_NAME, CITY_ENAME, NATION_NAME, NATION_ENAME, NATION_CODE, HOTEL_CNT
INTO #TMP_CITY
FROM (      
 SELECT CITY_CODE, CITY_NAME, CITY_ENAME, NATION_NAME, NATION_ENAME, NATION_CODE, SORT_ORDER,      
 (CASE WHEN CHARINDEX(',', REVERSE(LEFT(INDEX_NAME, CHARINDEX(@KEYWORD, INDEX_NAME)))) = 0       
 THEN CHARINDEX(@KEYWORD, INDEX_NAME)      
 ELSE CHARINDEX(',', REVERSE(LEFT(INDEX_NAME, CHARINDEX(@KEYWORD, INDEX_NAME)))) END) AS SORT1,      
 LEN(LEFT(INDEX_NAME, CHARINDEX(@KEYWORD, INDEX_NAME))) AS SORT2, HOTEL_CNT      
 FROM HTL_CODE_MAST_CITY      
 WHERE USE_YN='Y'      
 AND (UPPER(CITY_NAME) LIKE '%'+UPPER(@KEYWORD)+'%'      
 OR UPPER(CITY_ENAME) LIKE '%'+UPPER(@KEYWORD)+'%'      
 OR UPPER(INDEX_NAME) LIKE '%'+UPPER(@KEYWORD)+'%')      
     
 UNION ALL    
     
 SELECT TOP 100 CITY_CODE, CITY_NAME, CITY_NAME, AREA_NAME + '*' AS NATION_NAME, AREA_ENAME AS NATION_ENAME, CITY_NAME, SORT_ORDER, 9999, 9999, HOTEL_CNT   
 FROM HTL_CODE_MAST_AREA    
 WHERE USE_YN='Y'
 AND (UPPER(AREA_NAME) LIKE '%'+UPPER(@KEYWORD)+'%'      
 OR UPPER(AREA_ENAME) LIKE '%'+UPPER(@KEYWORD)+'%')    
    
) A      
ORDER BY SORT1, SORT2, SORT_ORDER 

--CREATE NONCLUSTERED INDEX IDX_TMP_CITY ON #TMP_CITY (CITY_CODE)


SELECT * FROM #TMP_CITY

--SELECT A.CITY_CODE, A.CITY_NAME, A.NATION_NAME, COUNT(B.HOTEL_CODE) AS HOTEL_CNT
--FROM #TMP_CITY A
--JOIN HTL_INFO_MAST_HOTEL B ON A.CITY_CODE=B.CITY_CODE
--WHERE B.USE_YN='Y'
--GROUP BY A.CITY_CODE, A.CITY_NAME, A.NATION_NAME, SORT1, SORT2, SORT_ORDER
--ORDER BY SORT1, SORT2, SORT_ORDER



GO
