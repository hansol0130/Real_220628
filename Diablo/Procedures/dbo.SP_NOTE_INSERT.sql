USE [Diablo]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[SP_NOTE_INSERT]
	@EMP_CODE VARCHAR(MAX),	--,구분 으로 사원코드가 넘어옴 EX)2007086,2007087,2007078,
	@SEND_CAT_SEQ_NO INT,
	@FILEURL VARCHAR(300),
	@FILENAME VARCHAR(200),
	@CONTENTS nVARCHAR(MAX),
	@SUBJECT VARCHAR(300),
	@NEW_CODE VARCHAR(7)
AS
BEGIN

 	SET NOCOUNT OFF;
	DECLARE @SEQ INT;
	DECLARE @TEMP_EMP VARCHAR(10);
	DECLARE @INDEX INT;
	DECLARE @TEMP_EMP_LIST VARCHAR(MAX);

		SET @INDEX = CHARINDEX(',', @EMP_CODE);
		
		--INDEX가 0이 아닌 멀티일경우, WHILE문을 위해...마지막에 ,를 하나 더부여함
		IF @INDEX = 0
			BEGIN
				IF @EMP_CODE = '9999999'   --전체전송일 경우
				BEGIN				
					INSERT PUB_NOTE
					SELECT 
							A.EMP_CODE,		(ISNULL(MAX(B.SEQ_NO),0)+1),	0,				@SEND_CAT_SEQ_NO,
							@SUBJECT,		@CONTENTS,						@FILENAME,		'N',			
							null,				'N',							@FILEURL,		@NEW_CODE,
							GETDATE()					
					FROM EMP_MASTER A LEFT JOIN PUB_NOTE B ON A.EMP_CODE = B.EMP_CODE 
					WHERE A.WORK_TYPE <> '5'
					GROUP BY A.EMP_CODE;
				END 
				ELSE  --일반 한명 전송일 경우
				BEGIN
					SELECT @SEQ = ( (ISNULL(MAX(SEQ_NO),0) + 1) + 1) FROM PUB_NOTE WHERE EMP_CODE=@EMP_CODE;
					INSERT INTO PUB_NOTE
						(EMP_CODE,SEQ_NO,SEND_CAT_SEQ_NO,CAT_SEQ_NO,FILEURL,FILENAME,CONTENTS,SUBJECT,NEW_CODE)
					VALUES
						(@EMP_CODE,@SEQ,@SEND_CAT_SEQ_NO ,0,@FILEURL,@FILENAME,@CONTENTS,@SUBJECT,@NEW_CODE);			
				END
			END
		ELSE  --멀티 전송일 경우
			BEGIN		
				SET @EMP_CODE = @EMP_CODE + ','						
				WHILE NOT (@INDEX=0)
				BEGIN
					--PRINT (@INDEX)
					SET @TEMP_EMP = LEFT(@EMP_CODE, @INDEX - 1);
					SET @TEMP_EMP_LIST = RIGHT(@EMP_CODE, LEN(@EMP_CODE) - @INDEX);
					
					SELECT @SEQ = ( (ISNULL(MAX(SEQ_NO),0) + 1) + 1) FROM PUB_NOTE WHERE EMP_CODE=@TEMP_EMP

					INSERT INTO PUB_NOTE
						(EMP_CODE,SEQ_NO,SEND_CAT_SEQ_NO,CAT_SEQ_NO,FILEURL,FILENAME,CONTENTS,SUBJECT,NEW_CODE)
					VALUES
						(@TEMP_EMP,@SEQ,@SEND_CAT_SEQ_NO ,0,@FILEURL,@FILENAME,@CONTENTS,@SUBJECT,@NEW_CODE)

				
					SET @INDEX = CHARINDEX(',', @TEMP_EMP_LIST);
					SET @EMP_CODE = @TEMP_EMP_LIST					
				END 

			END
END

GO
