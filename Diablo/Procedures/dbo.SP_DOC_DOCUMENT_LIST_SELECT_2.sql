USE [Diablo]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
	2012-03-02 READ UNCOMMITTED 설정
*/
CREATE PROCEDURE [dbo].[SP_DOC_DOCUMENT_LIST_SELECT_2]
	@FLAG			VARCHAR(3),
	@EMP_CODE		CHAR(7),
	@PAGESIZE		INT,
	@IPAGE			INT,
	@WHERE			VARCHAR(1000)
AS
BEGIN
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

--	declare @FLAG VARCHAR(3), @EMP_CODE CHAR(7), @PAGESIZE INT, @IPAGE INT, @WHERE VARCHAR(1000)
--
--	set @flag = '92'
--	set @emp_code = '2008004'
--	set @pagesize = 15
--	set @ipage = 0
--	set @where = ''

	DECLARE @QUERY VARCHAR(8000), @GROUP_CODES VARCHAR(200);

	IF @FLAG = '11'			-- 진행결재함		자신이 작성하고 문서상태가 진행중인 문서
	BEGIN
		SET @QUERY = '
		SELECT COUNT(*) FROM EDI_MASTER A
		WHERE A.NEW_CODE = ''' + @EMP_CODE + ''' AND A.EDI_STATUS = ''1''
		--#검색조건'
	END
	ELSE IF @FLAG = '12'
	BEGIN
		SET @QUERY = '
		WITH DOCUMENTLIST AS
		(
			SELECT
				ROW_NUMBER() OVER (ORDER BY EDI_CODE DESC) AS [ROWNUMBER],
				(
					SELECT [APP_NAME] FROM EDI_APPROVAL
					WHERE EDI_CODE = A.EDI_CODE AND APP_STATUS = ''N''
				) AS [APP_NAME], ''Y'' AS [READ_YN],
				A.*
			FROM EDI_MASTER A
			WHERE A.NEW_CODE = ''' + @EMP_CODE + ''' AND A.EDI_STATUS = ''1''
			--#검색조건
		)
		SELECT * FROM DOCUMENTLIST
		WHERE ROWNUMBER BETWEEN ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + 1)) + ' AND ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + @PAGESIZE)) + ';'
	END
	ELSE IF @FLAG = '21'	--반송결재함		자신이 작성하고 문서상태가 반송 또는 수신자처리코드가 거부인 문서
	BEGIN
		SET @QUERY = '
		SELECT COUNT(*) FROM EDI_MASTER A
		WHERE A.NEW_CODE = ''' + @EMP_CODE + ''' AND A.EDI_STATUS = ''2''
		--#검색조건'
	END
	ELSE IF @FLAG = '22'
	BEGIN
		SET @QUERY = '
		WITH DOCUMENTLIST AS
		(
			SELECT
				ROW_NUMBER() OVER (ORDER BY EDI_CODE DESC) AS [ROWNUMBER],
				(
					SELECT [APP_NAME] FROM EDI_APPROVAL
					WHERE EDI_CODE = A.EDI_CODE AND APP_STATUS = ''N''
				) AS [APP_NAME], ''Y'' AS [READ_YN],
				A.*
			FROM EDI_MASTER A
			WHERE A.NEW_CODE = ''' + @EMP_CODE + ''' AND A.EDI_STATUS = ''2''
			--#검색조건
		)
		SELECT * FROM DOCUMENTLIST
		WHERE ROWNUMBER BETWEEN ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + 1)) + ' AND ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + @PAGESIZE)) + ';'
	END
	ELSE IF @FLAG = '31'	--완료결재함		자신이 작성하고 문서상태가 완료인 문서
	BEGIN
		SET @QUERY = '
		SELECT COUNT(*) FROM EDI_MASTER A
		WHERE A.NEW_CODE = ''' + @EMP_CODE + ''' AND A.EDI_STATUS = ''3''
		--#검색조건'
	END
	ELSE IF @FLAG = '32'
	BEGIN
		SET @QUERY = '
		WITH DOCUMENTLIST AS
		(
			SELECT
				ROW_NUMBER() OVER (ORDER BY EDI_CODE DESC) AS [ROWNUMBER],
				(
					SELECT [APP_NAME] FROM EDI_APPROVAL
					WHERE EDI_CODE = A.EDI_CODE AND APP_STATUS = ''N''
				) AS [APP_NAME], ''Y'' AS [READ_YN],
				A.*
			FROM EDI_MASTER A
			WHERE A.NEW_CODE = ''' + @EMP_CODE + ''' AND A.EDI_STATUS = ''3''
			--#검색조건
		)
		SELECT * FROM DOCUMENTLIST
		WHERE ROWNUMBER BETWEEN ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + 1)) + ' AND ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + @PAGESIZE)) + ';'
	END
	ELSE IF @FLAG = '41'	--결재예정함		결재자 테이블에 결재 여부가 N으로 되어 있는 문서
	BEGIN
		SET @QUERY = '
		SELECT COUNT(*) FROM EDI_APPROVAL A
		INNER JOIN EDI_MASTER B ON A.EDI_CODE = B.EDI_CODE
		WHERE A.APP_CODE = ''' + @EMP_CODE + ''' AND A.APP_STATUS = ''N''
		--#검색조건'
	END
	ELSE IF @FLAG = '42'
	BEGIN
		SET @QUERY = '
		WITH DOCUMENTLIST AS
		(
			SELECT
				ROW_NUMBER() OVER (ORDER BY B.EDI_CODE DESC) AS [ROWNUMBER],
				(
					SELECT [APP_NAME] FROM EDI_APPROVAL
					WHERE EDI_CODE = A.EDI_CODE AND APP_STATUS = ''N''
				) AS [APP_NAME], A.READ_YN,
				B.* 
			FROM EDI_APPROVAL A
			INNER JOIN EDI_MASTER B ON A.EDI_CODE = B.EDI_CODE
			WHERE A.APP_CODE = ''' + @EMP_CODE + ''' AND A.APP_STATUS = ''N''
			--#검색조건
		)
		SELECT * FROM DOCUMENTLIST
		WHERE ROWNUMBER BETWEEN ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + 1)) + ' AND ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + @PAGESIZE)) + ';'
	END
	ELSE IF @FLAG = '51'	--진행결재함		결재자에 포함되어 있고 문서상태가 진행중인 문서
	BEGIN
		SET @QUERY = '
		SELECT COUNT(*) FROM EDI_APPROVAL A
		INNER JOIN EDI_MASTER B ON A.EDI_CODE = B.EDI_CODE
		WHERE A.APP_CODE = ''' + @EMP_CODE + ''' AND A.APP_STATUS = ''Y'' AND B.EDI_STATUS = ''1''
		--#검색조건'
	END
	ELSE IF @FLAG = '52'
	BEGIN
		SET @QUERY = '
		WITH DOCUMENTLIST AS
		(
			SELECT
				ROW_NUMBER() OVER (ORDER BY B.EDI_CODE DESC) AS [ROWNUMBER],
				(
					SELECT [APP_NAME] FROM EDI_APPROVAL
					WHERE EDI_CODE = A.EDI_CODE AND APP_STATUS = ''N''
				) AS [APP_NAME], A.READ_YN,
				B.* 
			FROM EDI_APPROVAL A
			INNER JOIN EDI_MASTER B ON A.EDI_CODE = B.EDI_CODE
			WHERE A.APP_CODE = ''' + @EMP_CODE + ''' AND A.APP_STATUS = ''Y'' AND B.EDI_STATUS = ''1''
			--#검색조건
		)
		SELECT * FROM DOCUMENTLIST
		WHERE ROWNUMBER BETWEEN ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + 1)) + ' AND ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + @PAGESIZE)) + ';'
	END
	ELSE IF @FLAG = '61'	--반송결재함	결재자에 포함되어 있고 문서상태가 반송 또는 수신자처리코드가 거부인 문서
	BEGIN
		SET @QUERY = '
		SELECT COUNT(*) FROM EDI_APPROVAL A
		INNER JOIN EDI_MASTER B ON A.EDI_CODE = B.EDI_CODE
		WHERE A.APP_CODE = ''' + @EMP_CODE + ''' AND A.APP_STATUS = ''Y'' AND B.EDI_STATUS = ''2''
		--#검색조건'
	END
	ELSE IF @FLAG = '62'
	BEGIN
		SET @QUERY = '
		WITH DOCUMENTLIST AS
		(
			SELECT
				ROW_NUMBER() OVER (ORDER BY B.EDI_CODE DESC) AS [ROWNUMBER],
				(
					SELECT [APP_NAME] FROM EDI_APPROVAL
					WHERE EDI_CODE = A.EDI_CODE AND APP_STATUS = ''N''
				) AS [APP_NAME], A.READ_YN,
				B.* 
			FROM EDI_APPROVAL A
			INNER JOIN EDI_MASTER B ON A.EDI_CODE = B.EDI_CODE
			WHERE A.APP_CODE = ''' + @EMP_CODE + ''' AND A.APP_STATUS = ''Y'' AND B.EDI_STATUS = ''2''
			--#검색조건
		)
		SELECT * FROM DOCUMENTLIST
		WHERE ROWNUMBER BETWEEN ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + 1)) + ' AND ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + @PAGESIZE)) + ';'
	END
	ELSE IF @FLAG = '71'	--완료결재함	결재자에 포함되어 있고 문서상태가 완료인 문서
	BEGIN
		SET @QUERY = '
		SELECT COUNT(*) FROM EDI_APPROVAL A
		INNER JOIN EDI_MASTER B ON A.EDI_CODE = B.EDI_CODE
		WHERE A.APP_CODE = ''' + @EMP_CODE + ''' AND A.APP_STATUS = ''Y'' AND B.EDI_STATUS = ''3''
		--#검색조건'
	END
	ELSE IF @FLAG = '72'
	BEGIN
		SET @QUERY = '
		WITH DOCUMENTLIST AS
		(
			SELECT
				ROW_NUMBER() OVER (ORDER BY B.EDI_CODE DESC) AS [ROWNUMBER],
				(
					SELECT [APP_NAME] FROM EDI_APPROVAL
					WHERE EDI_CODE = A.EDI_CODE AND APP_STATUS = ''N''
				) AS [APP_NAME], A.READ_YN,
				B.* 
			FROM EDI_APPROVAL A
			INNER JOIN EDI_MASTER B ON A.EDI_CODE = B.EDI_CODE
			WHERE A.APP_CODE = ''' + @EMP_CODE + ''' AND A.APP_STATUS = ''Y'' AND B.EDI_STATUS = ''3''
			--#검색조건
		)
		SELECT * FROM DOCUMENTLIST
		WHERE ROWNUMBER BETWEEN ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + 1)) + ' AND ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + @PAGESIZE)) + ';'
	END
	ELSE IF @FLAG = '81'	--참조함	참조자에 포함되어 있는 모든 문서
	BEGIN
		SET @QUERY = '
		SELECT COUNT(*) FROM EDI_REFERENCE A
		INNER JOIN EDI_MASTER B ON A.EDI_CODE = B.EDI_CODE
		WHERE A.REF_CODE = ''' + @EMP_CODE + '''
		--#검색조건'
	END
	ELSE IF @FLAG = '82'
	BEGIN
		SET @QUERY = '
		WITH DOCUMENTLIST AS
		(
			SELECT
				ROW_NUMBER() OVER (ORDER BY B.EDI_CODE DESC) AS [ROWNUMBER],
				(
					SELECT [APP_NAME] FROM EDI_APPROVAL
					WHERE EDI_CODE = A.EDI_CODE AND APP_STATUS = ''N''
				) AS [APP_NAME], A.READ_YN,
				B.* 
			FROM EDI_REFERENCE A
			INNER JOIN EDI_MASTER B ON A.EDI_CODE = B.EDI_CODE
			WHERE A.REF_CODE = ''' + @EMP_CODE + '''
			--#검색조건
		)
		SELECT * FROM DOCUMENTLIST
		WHERE ROWNUMBER BETWEEN ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + 1)) + ' AND ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + @PAGESIZE)) + ';'
	END
	ELSE IF @FLAG = '91'	--지결회계처리함	일반결재가 완료된 지결문서
	BEGIN
		SET @QUERY = '-- DOC_TYPE:4(지결), EDI_STATUS:1(진행중), APP_TYPE:2(회계라인)
		WITH DOCUMENTLIST AS
		(
			SELECT * 
			FROM EDI_MASTER
			WHERE DOC_TYPE = ''4'' AND EDI_STATUS = ''1'' AND APP_TYPE = ''2''
		)
		SELECT COUNT(*) FROM DOCUMENTLIST A
		WHERE EDI_CODE NOT IN (
			SELECT A.EDI_CODE FROM DOCUMENTLIST A
			INNER JOIN EDI_APPROVAL B ON A.EDI_CODE = B.EDI_CODE
			WHERE B.APP_TYPE = ''2''
		) AND RCV_TEAM_CODE IN (SELECT TEAM_CODE FROM EMP_MASTER_damo WHERE EMP_CODE = ''' + @EMP_CODE + ''')
		--#검색조건'
	END
	ELSE IF @FLAG = '92'
	BEGIN
		SET @QUERY = '-- DOC_TYPE:4(지결), EDI_STATUS:1(진행중), APP_TYPE:2(회계라인)
		WITH DOCUMENTLIST AS
		(
			SELECT
				ROW_NUMBER() OVER (ORDER BY EDI_CODE DESC) AS [ROWNUMBER],
				*
			FROM
			(
				SELECT * 
				FROM EDI_MASTER
				WHERE DOC_TYPE = ''4'' AND EDI_STATUS = ''1'' AND APP_TYPE = ''2''
			) A
			WHERE EDI_CODE NOT IN
			(
				SELECT A.EDI_CODE FROM
				(
					SELECT * 
					FROM EDI_MASTER
					WHERE DOC_TYPE = ''4'' AND EDI_STATUS = ''1'' AND APP_TYPE = ''2''
				) A
				INNER JOIN EDI_APPROVAL B ON A.EDI_CODE = B.EDI_CODE
				WHERE B.APP_TYPE = ''2''
			)
			AND RCV_TEAM_CODE IN (SELECT TEAM_CODE FROM EMP_MASTER_damo WHERE EMP_CODE = ''' + @EMP_CODE + ''')
			--#검색조건
		)
		SELECT *, ''Y'' AS [READ_YN] FROM DOCUMENTLIST
		WHERE ROWNUMBER BETWEEN ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + 1)) + ' AND ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + @PAGESIZE)) + ';'
	END
	ELSE IF @FLAG = '101'	--지결회계처리함	부서수신문서
	BEGIN
		IF ((SELECT ISNULL(GROUP_CODE, '') FROM EMP_MASTER_damo WHERE EMP_CODE = @EMP_CODE) = '')
		BEGIN
			SET @QUERY = '
			SELECT COUNT(*) FROM EDI_MASTER
			WHERE EDI_STATUS = ''3'' AND RCV_TEAM_CODE IN (
			SELECT TEAM_CODE FROM EMP_MASTER_damo WHERE EMP_CODE = ''' + @EMP_CODE + ''')
			--#검색조건'
		END
		ELSE
		BEGIN
			WITH GROUP_LIST AS
			(
				SELECT GROUP_CODE, PARENT_CODE, 0 AS [DEPTH] FROM EMP_GROUP_MASTER
				WHERE GROUP_CODE LIKE
				(
					SELECT (GROUP_CODE + '_') FROM EMP_MASTER
					WHERE EMP_CODE = @EMP_CODE
				)
				UNION ALL
				SELECT A.GROUP_CODE, A.PARENT_CODE, B.DEPTH + 1
				FROM EMP_GROUP_MASTER A
				INNER JOIN GROUP_LIST B ON A.PARENT_CODE = B.GROUP_CODE
			)
			SELECT
				@GROUP_CODES = (STUFF ((SELECT (', ''' + GROUP_CODE + '''') AS [text()] FROM GROUP_LIST FOR XML PATH('')), 1, 2, ''))

			SET @QUERY = 
			'SELECT count(*) FROM EDI_MASTER
			WHERE RCV_TEAM_CODE IN 
			(
				SELECT TEAM_CODE FROM EMP_GROUP_DETAIL
				WHERE GROUP_CODE IN (' + @GROUP_CODES + ')
			) AND EDI_STATUS = ''3''
			--#검색조건'

		END
	END
	ELSE IF @FLAG = '102'	--지결회계처리함	부서수신문서
	BEGIN
		IF ((SELECT ISNULL(GROUP_CODE, '') FROM EMP_MASTER_damo WHERE EMP_CODE = @EMP_CODE) = '')
		BEGIN
			SET @QUERY = '
			WITH DOCUMENTLIST AS
			(
				SELECT
					ROW_NUMBER() OVER (ORDER BY A.EDI_CODE DESC) AS [ROWNUMBER],
					* 
				FROM EDI_MASTER A
				WHERE EDI_STATUS = ''3'' AND RCV_TEAM_CODE IN
				(
					SELECT TEAM_CODE FROM EMP_MASTER_damo WHERE EMP_CODE = ''' + @EMP_CODE + '''
				)
				--#검색조건
			)
			SELECT *, ''Y'' AS [READ_YN] FROM DOCUMENTLIST
			WHERE ROWNUMBER BETWEEN ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + 1)) + ' AND ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + @PAGESIZE)) + ';'
		END
		ELSE
		BEGIN
			WITH GROUP_LIST AS
			(
				SELECT GROUP_CODE, PARENT_CODE, 0 AS [DEPTH] FROM EMP_GROUP_MASTER
				WHERE GROUP_CODE LIKE
				(
					SELECT (GROUP_CODE + '_') FROM EMP_MASTER
					WHERE EMP_CODE = @EMP_CODE
				)
				UNION ALL
				SELECT A.GROUP_CODE, A.PARENT_CODE, B.DEPTH + 1
				FROM EMP_GROUP_MASTER A
				INNER JOIN GROUP_LIST B ON A.PARENT_CODE = B.GROUP_CODE
			)
			SELECT
				@GROUP_CODES = (STUFF ((SELECT (', ''' + GROUP_CODE + '''') AS [text()] FROM GROUP_LIST FOR XML PATH('')), 1, 2, ''))

			SET @QUERY = '
			WITH DOCUMENTLIST AS
			(
				SELECT
					ROW_NUMBER() OVER (ORDER BY A.EDI_CODE DESC) AS [ROWNUMBER],
					* 
				FROM EDI_MASTER A
				WHERE RCV_TEAM_CODE IN 
				(
					SELECT TEAM_CODE FROM EMP_GROUP_DETAIL
					WHERE GROUP_CODE IN (' + @GROUP_CODES + ')
				) AND EDI_STATUS = ''3''
				--#검색조건
			)
			SELECT *, ''Y'' AS [READ_YN] FROM DOCUMENTLIST
			WHERE ROWNUMBER BETWEEN ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + 1)) + ' AND ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + @PAGESIZE)) + ';'
		END
	END
	ELSE IF @FLAG = '111'	--지결회계처리함	부서수신문서
	BEGIN
		SET @QUERY = '
		SELECT count(*) FROM EDI_MASTER
		WHERE EDI_STATUS = ''3'' AND RCV_TEAM_CODE IN (
		SELECT TEAM_CODE FROM EMP_MASTER_damo WHERE EMP_CODE = ''' + @EMP_CODE + ''')
		--#검색조건'
	END
	ELSE IF @FLAG = '112'
	BEGIN
		SET @QUERY = '
		WITH DOCUMENTLIST AS
		(
			SELECT
				ROW_NUMBER() OVER (ORDER BY A.EDI_CODE DESC) AS [ROWNUMBER],
				* 
			FROM EDI_MASTER A
			WHERE EDI_STATUS = ''3'' AND RCV_TEAM_CODE IN
			(
				SELECT TEAM_CODE FROM EMP_MASTER_damo WHERE EMP_CODE = ''' + @EMP_CODE + '''
			)
			--#검색조건
		)
		SELECT * FROM DOCUMENTLIST
		WHERE ROWNUMBER BETWEEN ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + 1)) + ' AND ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + @PAGESIZE)) + ';'
	END

	IF @WHERE IS NOT NULL
		SET @QUERY = REPLACE(@QUERY, '--#검색조건', @WHERE)

	EXEC (@QUERY)
	--PRINT (@QUERY)

END

--EXEC SP_DOC_DOCUMENT_LIST_SELECT '82', '2008011', 15, 0, ''
GO
