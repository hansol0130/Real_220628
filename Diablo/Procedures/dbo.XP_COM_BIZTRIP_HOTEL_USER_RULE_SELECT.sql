USE [Diablo]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*================================================================================================================
■ USP_NAME					: XP_COM_BIZTRIP_HOTEL_USER_RULE_SELECT
■ DESCRIPTION				: BTMS 출장자 규정 검색
■ INPUT PARAMETER			: 
	@AGT_CODE				: 거래처코드
	@EMP_SEQ				: 직원 번호
	@REG_CODE				: 출장지역코드
■ OUTPUT PARAMETER			: 
■ EXEC						: 

	EXEC DBO.XP_COM_BIZTRIP_HOTEL_USER_RULE_SELECT 92756, '122,109,118,123'

■ MEMO						: 
------------------------------------------------------------------------------------------------------------------
■ CHANGE HISTORY
------------------------------------------------------------------------------------------------------------------
   DATE				AUTHOR			DESCRIPTION           
------------------------------------------------------------------------------------------------------------------
   2016-02-24		JUSTGO(이유라)			최초생성
   2016-03-14		김성호				리뉴얼
   2016-08-19		이유라				정렬순서 수정
================================================================================================================*/
CREATE PROC [dbo].[XP_COM_BIZTRIP_HOTEL_USER_RULE_SELECT]
	@AGT_CODE	VARCHAR(10),
	@EMP_SEQ_STRING	VARCHAR(500)

AS

BEGIN

	WITH EMP_LIST AS
	(
		SELECT * FROM DBO.FN_COM_BIZTRIP_GROUP_INFO(@AGT_CODE, @EMP_SEQ_STRING) A
	)
	, COUNT_LIST AS (
		SELECT A.AGT_CODE, A.EMP_SEQ, A.BT_SEQ, COUNT(*) AS [RULE_COUNT]
		FROM EMP_LIST A
		LEFT JOIN COM_HOTEL_RULE B ON A.AGT_CODE = B.AGT_CODE AND A.BT_SEQ = B.BT_SEQ AND B.USE_YN = 'Y'
		GROUP BY A.AGT_CODE, A.EMP_SEQ, A.BT_SEQ
	)
	SELECT
		A.AGT_CODE, A.BT_SEQ, A.EMP_SEQ, D.KOR_NAME AS EMP_NAME, E.POS_NAME, F.TEAM_NAME,
		B.HOTEL_LIKE_YN, C.LIMIT_PRICE, A.ORDER_NUM,
		(SELECT AA.REGION_LIST FROM DBO.FN_COM_REGION_INFO(A.AGT_CODE, C.REG_MASTER_SEQ) AA) AS REGION,
		(SELECT RULE_COUNT FROM COUNT_LIST AA WHERE AA.AGT_CODE = A.AGT_CODE AND AA.EMP_SEQ = A.EMP_SEQ AND AA.BT_SEQ = A.BT_SEQ) AS [RULE_COUNT]
	FROM EMP_LIST A
	LEFT JOIN COM_BIZTRIP_GROUP B WITH(NOLOCK) ON A.AGT_CODE = B.AGT_CODE AND A.BT_SEQ = B.BT_SEQ
	LEFT JOIN COM_HOTEL_RULE C WITH(NOLOCK) ON A.AGT_CODE = C.AGT_CODE AND A.BT_SEQ = C.BT_SEQ AND C.USE_YN = 'Y'
	LEFT JOIN COM_EMPLOYEE D WITH(NOLOCK) ON A.AGT_CODE = D.AGT_CODE AND A.EMP_SEQ = D.EMP_SEQ
	LEFT JOIN COM_POSITION E WITH(NOLOCK) ON D.AGT_CODE = E.AGT_CODE AND D.POS_SEQ = E.POS_SEQ
	LEFT JOIN COM_TEAM F WITH(NOLOCK) ON D.AGT_CODE = F.AGT_CODE AND D.TEAM_SEQ = F.TEAM_SEQ
	--ORDER BY A.AGT_CODE, A.EMP_SEQ, B.ORDER_NUM
	ORDER BY A.AGT_CODE, B.ORDER_NUM

	--WITH LIST AS
	--(
	--	SELECT
	--		A.AGT_CODE, A.BT_SEQ, A.EMP_SEQ, D.KOR_NAME AS EMP_NAME, E.POS_NAME, F.TEAM_NAME,
	--		B.HOTEL_LIKE_YN, C.LIMIT_PRICE, A.ORDER_NUM,
	--		(SELECT AA.REGION_LIST FROM DBO.FN_COM_REGION_INFO(A.AGT_CODE, C.REG_MASTER_SEQ) AA) AS REGION
	--	FROM DBO.FN_COM_BIZTRIP_GROUP_INFO(@AGT_CODE, @EMP_SEQ_STRING) A
	--	LEFT JOIN COM_BIZTRIP_GROUP B WITH(NOLOCK) ON A.AGT_CODE = B.AGT_CODE AND A.BT_SEQ = B.BT_SEQ
	--	LEFT JOIN COM_HOTEL_RULE C WITH(NOLOCK) ON A.AGT_CODE = C.AGT_CODE AND A.BT_SEQ = C.BT_SEQ AND C.USE_YN = 'Y'
	--	LEFT JOIN COM_EMPLOYEE D WITH(NOLOCK) ON A.AGT_CODE = D.AGT_CODE AND A.EMP_SEQ = D.EMP_SEQ
	--	LEFT JOIN COM_POSITION E WITH(NOLOCK) ON D.AGT_CODE = E.AGT_CODE AND D.POS_SEQ = E.POS_SEQ
	--	LEFT JOIN COM_TEAM F WITH(NOLOCK) ON D.AGT_CODE = F.AGT_CODE AND D.TEAM_SEQ = F.TEAM_SEQ
	--	ORDER BY A.AGT_CODE, A.EMP_SEQ, B.ORDER_NUM
	--)
	--SELECT *, (SELECT COUNT(*) 
	--FROM LIST A

	--WITH MASTER_LIST AS
	--(
	--	SELECT A.AGT_CODE, A.REG_MASTER_SEQ, A.REGION_NAME, A.ALL_YN, A.USE_YN
	--	FROM COM_REGION_MASTER A WITH(NOLOCK)
	--	WHERE A.AGT_CODE = @AGT_CODE AND A.USE_YN = 'Y'
	--), DETAIL_LIST AS
	--(
	--	SELECT A.*, B.REG_DETAIL_SEQ, B.REG_TYPE, B.REG_CODE
	--	FROM MASTER_LIST A
	--	INNER JOIN COM_REGION_DETAIL B WITH(NOLOCK) ON A.AGT_CODE = B.AGT_CODE AND A.REG_MASTER_SEQ = B.REG_MASTER_SEQ
	--	WHERE A.ALL_YN = 'N' AND B.USE_YN = 'Y'
	--)
	--SELECT
	--	AGT_CODE, REG_MASTER_SEQ, USE_YN, REGION_LIST
	--INTO #TMP_TABLE
	--FROM (
	--	SELECT A.AGT_CODE, A.REG_MASTER_SEQ, B.USE_YN, (MAX(REGION) + MAX(NATION) + MAX(CITY)) AS [REGION_LIST]
	--	FROM
	--	(
	--		SELECT A.AGT_CODE, A.REG_MASTER_SEQ, '전지역' AS [REGION], '' AS [NATION], '' AS [CITY]
	--		FROM MASTER_LIST A
	--		WHERE A.ALL_YN = 'Y'
	--		UNION ALL
	--		SELECT A.AGT_CODE, A.REG_MASTER_SEQ, (
	--			SELECT (KOR_NAME + ',') AS [text()] 
	--			FROM DETAIL_LIST AA
	--			INNER JOIN PUB_REGION BB WITH(NOLOCK) ON AA.REG_MASTER_SEQ = A.REG_MASTER_SEQ AND AA.REG_CODE = BB.REGION_CODE
	--			WHERE AA.REG_TYPE = 'R' FOR XML PATH('')), '', ''
	--		FROM MASTER_LIST A
	--		UNION ALL
	--		SELECT A.AGT_CODE, A.REG_MASTER_SEQ, '', (
	--			SELECT (KOR_NAME + ',') AS [text()] 
	--			FROM DETAIL_LIST AA
	--			INNER JOIN PUB_NATION BB WITH(NOLOCK) ON AA.REG_MASTER_SEQ = A.REG_MASTER_SEQ AND AA.REG_CODE = BB.NATION_CODE
	--			WHERE AA.REG_TYPE = 'N' FOR XML PATH('')), ''
	--		FROM MASTER_LIST A
	--		UNION ALL
	--		SELECT A.AGT_CODE, A.REG_MASTER_SEQ, '', '', (
	--			SELECT (KOR_NAME + ',') AS [text()] 
	--			FROM DETAIL_LIST AA
	--			INNER JOIN PUB_CITY BB WITH(NOLOCK) ON AA.REG_MASTER_SEQ = A.REG_MASTER_SEQ AND AA.REG_CODE = BB.CITY_CODE
	--			WHERE AA.REG_TYPE = 'C' FOR XML PATH('')) AS [CITY_NAME]
	--		FROM MASTER_LIST A
	--	) A
	--	LEFT JOIN MASTER_LIST B ON A.AGT_CODE = B.AGT_CODE AND A.REG_MASTER_SEQ = B.REG_MASTER_SEQ
	--	GROUP BY A.AGT_CODE, A.REG_MASTER_SEQ, B.USE_YN
	--) REGION_MAST;

	--WITH TOP_GROUP_LIST AS
	--(
	--	SELECT
	--		ROW_NUMBER() OVER (PARTITION BY A.BT_EMP_SEQ ORDER BY MIN(B.ORDER_NUM) ASC) AS [ROW_NUMBER],
	--		A.AGT_CODE, A.BT_SEQ, A.BTE_SEQ, A.BT_EMP_SEQ,
	--		B.ALL_YN, B.REPORT_YN, B.EMAIL_SEND_YN, B.CONFIRM_YN, B.HOTEL_LIKE_YN, B.BTG_NAME, B.ORDER_NUM
	--	FROM COM_BIZTRIP_EMPLOYEE A WITH(NOLOCK)
	--	INNER JOIN COM_BIZTRIP_GROUP B WITH(NOLOCK) ON A.AGT_CODE = B.AGT_CODE AND A.BT_SEQ = B.BT_SEQ AND B.USE_YN = 'Y'
	--	WHERE A.AGT_CODE = @AGT_CODE AND A.BT_EMP_TYPE = 'E' AND A.BT_EMP_SEQ IN (SELECT Data From dbo.FN_XML_SPLIT(@EMP_SEQ_STRING, ','))
	--	GROUP BY A.AGT_CODE, A.BT_SEQ, A.BTE_SEQ, A.BT_EMP_SEQ, ORDER_NUM, B.ALL_YN, B.REPORT_YN, B.EMAIL_SEND_YN, B.CONFIRM_YN, B.HOTEL_LIKE_YN, B.AIR_SAME_YN, B.AIR_LIKE_YN, B.BTG_NAME
	--)
	--SELECT
	--	A.AGT_CODE, A.BT_SEQ, A.BTE_SEQ, A.BT_EMP_SEQ,
	--	C.KOR_NAME AS EMP_NAME, D.POS_NAME, E.TEAM_NAME,
	--	A.BTG_NAME, A.ALL_YN, A.REPORT_YN, A.EMAIL_SEND_YN, A.CONFIRM_YN, A.HOTEL_LIKE_YN,
	--	B.REG_MASTER_SEQ, B.HOTEL_RULE_SEQ, B.LIMIT_PRICE,
	--	(SELECT G.REGION_LIST FROM #TMP_TABLE G WHERE G.REG_MASTER_SEQ = B.REG_MASTER_SEQ AND G.USE_YN = 'Y') AS REGION,
	--	--(SELECT AA.REGION_LIST FROM DBO.FN_COM_REGION_INFO(A.AGT_CODE, B.REG_MASTER_SEQ) AA) AS REGION,
	--	A.ORDER_NUM, (SELECT COUNT(*) FROM COM_HOTEL_RULE F WHERE A.BT_SEQ = F.BT_SEQ AND F.USE_YN = 'Y') AS EMP_ROW_COUNT
	--FROM TOP_GROUP_LIST A
	--JOIN COM_HOTEL_RULE B WITH(NOLOCK) ON A.AGT_CODE = B.AGT_CODE AND A.BT_SEQ = B.BT_SEQ AND B.USE_YN = 'Y'
	--JOIN COM_EMPLOYEE C WITH(NOLOCK) ON A.AGT_CODE = C.AGT_CODE AND A.BT_EMP_SEQ = C.EMP_SEQ
	--LEFT JOIN COM_POSITION D WITH(NOLOCK) ON C.AGT_CODE = D.AGT_CODE AND C.POS_SEQ = D.POS_SEQ
	--LEFT JOIN COM_TEAM E WITH(NOLOCK) ON C.AGT_CODE = E.AGT_CODE AND C.TEAM_SEQ = E.TEAM_SEQ
	--WHERE A.ROW_NUMBER = 1
	--GROUP BY A.AGT_CODE, A.BT_SEQ, A.BTE_SEQ, A.BT_EMP_SEQ, C.KOR_NAME, D.POS_NAME, E.TEAM_NAME,
	--	A.BTG_NAME, A.ALL_YN, A.REPORT_YN, A.EMAIL_SEND_YN, A.CONFIRM_YN, A.HOTEL_LIKE_YN,
	--	B.REG_MASTER_SEQ, B.HOTEL_RULE_SEQ, B.LIMIT_PRICE, A.ORDER_NUM
	--ORDER BY A.ORDER_NUM DESC

	
END
GO
