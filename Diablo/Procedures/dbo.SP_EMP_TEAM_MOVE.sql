USE [Diablo]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[SP_EMP_TEAM_MOVE]
	@NEW_TEAM_CODE VARCHAR(3),
	@OLD_TEAM_CODE VARCHAR(3),
	@NEW_CODE VARCHAR(7)
AS
BEGIN
	SET NOCOUNT OFF;
	
	DECLARE @OLD_TEAM_NAME VARCHAR(50), @NEW_TEAM_NAME VARCHAR(50)
	
	SELECT @OLD_TEAM_NAME = ISNULL((SELECT TEAM_NAME FROM EMP_TEAM WHERE TEAM_CODE = @OLD_TEAM_CODE), '')
	SELECT @NEW_TEAM_NAME = ISNULL((SELECT TEAM_NAME FROM EMP_TEAM WHERE TEAM_CODE = @NEW_TEAM_CODE), '')
	
	-- 예약담당자 변경
	--UPDATE A SET SALE_TEAM_CODE = @NEW_TEAM_CODE, SALE_TEAM_NAME = @NEW_TEAM_NAME
	--FROM RES_MASTER_damo A
	--INNER JOIN EMP_MASTER_damo B ON A.SALE_EMP_CODE = B.EMP_CODE
	--WHERE B.TEAM_CODE=@OLD_TEAM_CODE
	
	--UPDATE A SET NEW_TEAM_CODE = @NEW_TEAM_CODE, NEW_TEAM_NAME = @NEW_TEAM_NAME
	--FROM RES_MASTER_damo A
	--INNER JOIN EMP_MASTER_damo B ON A.NEW_CODE = B.EMP_CODE
	--WHERE B.TEAM_CODE=@OLD_TEAM_CODE
	
	--UPDATE A SET PROFIT_TEAM_CODE = @NEW_TEAM_CODE, PROFIT_TEAM_NAME = @NEW_TEAM_NAME
	--FROM RES_MASTER_damo A
	--INNER JOIN EMP_MASTER_damo B ON A.PROFIT_EMP_CODE = B.EMP_CODE
	--WHERE B.TEAM_CODE=@OLD_TEAM_CODE

	-- 이동내역 저장	
	INSERT INTO EMP_TEAM_MOVE (EMP_CODE, TEAM_CODE, MOV_DATE, REMARK, NEW_CODE)
	SELECT EMP_CODE, @NEW_TEAM_CODE, GETDATE(), (@OLD_TEAM_NAME + '에서 직원일괄이동'), @NEW_CODE
	FROM EMP_MASTER
	WHERE TEAM_CODE = @OLD_TEAM_CODE

	-- 사원정보 수정
	UPDATE EMP_MASTER_damo SET TEAM_CODE=@NEW_TEAM_CODE
	WHERE TEAM_CODE=@OLD_TEAM_CODE
END
GO
