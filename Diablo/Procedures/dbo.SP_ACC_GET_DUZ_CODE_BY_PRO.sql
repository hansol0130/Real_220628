USE [Diablo]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- 예약이 없이 행사만 있는 경우 가상번호를 생성하는 함수
-- 2010-9-1 이규식
CREATE PROCEDURE [dbo].[SP_ACC_GET_DUZ_CODE_BY_PRO]
(
	@PRO_CODE	VARCHAR(20)
)
 AS
BEGIN
	BEGIN TRAN
	
	DECLARE @DUZ_CODE VARCHAR(20), @DEP_STR VARCHAR(6), @TMP_DUZ_CODE VARCHAR(20)
	
	IF NOT EXISTS(SELECT 1 FROM ACC_MATCHING WHERE PRO_CODE = @PRO_CODE)
	BEGIN
		SELECT @DEP_STR = (
			CASE WHEN DEP_DATE IS NULL THEN SUBSTRING(@PRO_CODE, (CHARINDEX('-', @PRO_CODE) + 1), 6)
			ELSE CONVERT(VARCHAR(10), DEP_DATE, 12) END
		)
		FROM PKG_DETAIL
		WHERE PRO_CODE = @PRO_CODE
		
		SET @TMP_DUZ_CODE = ISNULL((SELECT TOP 1 DUZ_CODE FROM ACC_MATCHING WHERE DUZ_CODE LIKE (@DEP_STR + '%') ORDER BY DUZ_CODE DESC), '')
		
		-- 더존코드 EX)FORM : YYMMDD(출발일)-0001
		IF @TMP_DUZ_CODE = ''
		BEGIN
			SET @DUZ_CODE = (@DEP_STR + '-0001')
		END
		ELSE
		BEGIN
			SET @DUZ_CODE = (@DEP_STR + '-' + RIGHT(('0000' + CONVERT(VARCHAR(4), (CONVERT(INT, SUBSTRING(@TMP_DUZ_CODE, 8, 10)) + 1))), 4))
		END
		
		INSERT INTO ACC_MATCHING (DUZ_CODE, PRO_CODE) VALUES (@DUZ_CODE, @PRO_CODE)
	END
	
	COMMIT TRAN
END

GO
