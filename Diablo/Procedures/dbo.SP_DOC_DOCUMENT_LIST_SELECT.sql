USE [Diablo]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*================================================================================================================
■ USP_NAME					: SP_DOC_DOCUMENT_LIST_SELECT
■ DESCRIPTION				: 전자결재 리스트 검색
■ INPUT PARAMETER			: 
■ OUTPUT PARAMETER			: 
■ EXEC						: 
■ MEMO						: 

2017/12/15 박형만 
(SELECT [APP_NAME] FROM EDI_APPROVAL WHERE EDI_CODE = A.EDI_CODE AND APP_STATUS = ''N'')  <- 
이부분에서 한문서에 결제 안한 사람이 두명일경우 하위쿼리 반환 에러남 

exec SP_DOC_DOCUMENT_LIST_SELECT @FLAG=N'122',@EMP_CODE='2016035',@PAGESIZE=15,@IPAGE=0,@WHERE=N''

EXEC SP_DOC_DOCUMENT_LIST_SELECT '22', '2007044', 15, 0, 'AND DOC_TYPE = ''4'' AND ([SUBJECT] LIKE ''%세부%'' OR NEW_NAME = ''세부'')'
EXEC SP_DOC_DOCUMENT_LIST_SELECT '122', '2012041', 15, 0, ''
EXEC SP_DOC_DOCUMENT_LIST_SELECT '11', '2005097', 15, 0, ' AND ([SUBJECT] LIKE ''%1101112145%'' OR A.NEW_NAME = ''1101112145'' OR A.EDI_CODE = ''1101112145'')'

------------------------------------------------------------------------------------------------------------------
■ CHANGE HISTORY                   
------------------------------------------------------------------------------------------------------------------
   DATE				AUTHOR			DESCRIPTION           
------------------------------------------------------------------------------------------------------------------
   2008-04-26		김성호			최초생성
   2015-04-10		김성호			윤사장님 예외처리 (원복)
   2018-01-03		김성호			리스트 검색 그룹조건 적용되도록 수정
   2018-07-09		김성호			경영관리팀 대기함 권한 팀 추가 (기획감사/재무회계담당)
   2022-02-04		김성호			ORDER BY EDI_CODE DESC 기본 설정
   2022-06-13		김성호			@GROUP_CODES 크기 수정 VARCHAR(200) -> VARCHAR(1000)
================================================================================================================*/ 
CREATE PROCEDURE [dbo].[SP_DOC_DOCUMENT_LIST_SELECT]
	@FLAG			VARCHAR(3),
	@EMP_CODE		CHAR(7),
	@PAGESIZE		INT,
	@IPAGE			INT,
	@WHERE			VARCHAR(1000)
AS
BEGIN
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
--	declare @FLAG VARCHAR(3), @EMP_CODE CHAR(7), @PAGESIZE INT, @IPAGE INT, @WHERE VARCHAR(1000)
--
--	set @flag = '92'
--	set @emp_code = '2008004'
--	set @pagesize = 15
--	set @ipage = 0
--	set @where = ''

	DECLARE @QUERY VARCHAR(8000), @GROUP_CODES VARCHAR(1000) = '';

	-- 그룹설정 체크 ---------------------------------------------------------------------
	WITH GROUP_LIST AS
	(
		SELECT A.GROUP_CODE, A.PARENT_CODE, 0 AS [DEPTH]
		FROM EMP_GROUP_MASTER A WITH(NOLOCK)
		WHERE A.GROUP_CODE LIKE (SELECT (GROUP_CODE + '_') FROM EMP_MASTER_damo WITH(NOLOCK) WHERE EMP_CODE = @EMP_CODE)
		UNION ALL
		SELECT A.GROUP_CODE, A.PARENT_CODE, B.[DEPTH] + 1
		FROM EMP_GROUP_MASTER A WITH(NOLOCK)
		INNER JOIN GROUP_LIST B ON A.PARENT_CODE = B.GROUP_CODE
	)
	SELECT @GROUP_CODES = ISNULL((STUFF ((SELECT (', ''' + GROUP_CODE + '''') AS [text()] FROM GROUP_LIST FOR XML PATH('')), 1, 2, '')), '')

	IF EXISTS(SELECT 1 FROM EMP_MASTER_damo A WITH(NOLOCK) WHERE A.EMP_CODE = @EMP_CODE AND (A.GROUP_CODE IS NULL OR A.GROUP_CODE = ''))
	BEGIN
		-- 그룹코드 없음
		SET @GROUP_CODES = 'SELECT TEAM_CODE FROM EMP_MASTER_damo AA WITH(NOLOCK) WHERE AA.EMP_CODE = ''' + @EMP_CODE + ''''
	END
	ELSE
	BEGIN
		-- 그룹코드 있음
		SET @GROUP_CODES = 'SELECT TEAM_CODE FROM EMP_GROUP_DETAIL AA WITH(NOLOCK) WHERE GROUP_CODE IN (' + @GROUP_CODES + ')'
	END
	-------------------------------------------------------------------------------------

	IF @FLAG = '11'					--결재예정함		결재자 테이블에 결재 여부가 N으로 되어 있는 문서
	BEGIN
		SET @QUERY = '
		SELECT COUNT(*) FROM EDI_APPROVAL B
		INNER JOIN EDI_MASTER_DAMO A ON A.EDI_CODE = B.EDI_CODE
		WHERE A.EDI_STATUS = ''1'' AND B.APP_CODE = ''' + @EMP_CODE + ''' AND B.APP_STATUS = ''N''
		--#검색조건'
	END
	ELSE IF @FLAG = '12'
	BEGIN
		SET @QUERY = '
		WITH DOCUMENTLIST AS
		(
			SELECT
				ROW_NUMBER() OVER (ORDER BY A.NEW_DATE) AS [ROWNUMBER],
				(
					SELECT TOP 1 [APP_NAME] FROM EDI_APPROVAL
					WHERE EDI_CODE = A.EDI_CODE AND APP_STATUS = ''N''
				) AS [APP_NAME], B.READ_YN,
				A.*
			FROM EDI_APPROVAL B
			INNER JOIN EDI_MASTER_DAMO A ON A.EDI_CODE = B.EDI_CODE
			WHERE A.EDI_STATUS = ''1'' AND B.APP_CODE = ''' + @EMP_CODE + ''' AND B.APP_STATUS = ''N''
			--#검색조건
		)
		SELECT *,
			(SELECT COUNT(*) FROM EDI_COMMENT WHERE EDI_CODE = A.EDI_CODE) AS [COMMENT_COUNT]
		FROM DOCUMENTLIST A
		WHERE ROWNUMBER BETWEEN ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + 1)) + ' AND ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + @PAGESIZE)) + '
		ORDER BY A.EDI_CODE DESC;'
	END
	ELSE IF @FLAG = '21'			-- 진행문서함		자신이 작성자 또는 결재자인 진행중 문서
	BEGIN
		SET @QUERY = '
		SELECT COUNT(*) FROM
		(
			SELECT EDI_CODE FROM EDI_MASTER_DAMO A
			WHERE EDI_STATUS = ''1'' AND NEW_CODE = ''' + @EMP_CODE + ''' AND VIEW_YN = ''Y''
			--#검색조건
			UNION
			SELECT A.EDI_CODE FROM EDI_MASTER_DAMO A
			INNER JOIN EDI_APPROVAL B ON A.EDI_CODE = B.EDI_CODE
			WHERE A.EDI_STATUS = ''1'' AND B.APP_CODE = ''' + @EMP_CODE + ''' AND B.APP_STATUS = ''Y'' AND B.VIEW_YN = ''Y''
			--#검색조건
		) A'
	END
	ELSE IF @FLAG = '22'
	BEGIN
		SET @QUERY = '
		WITH DOCUMENTLIST AS
		(
			SELECT ROW_NUMBER() OVER (ORDER BY B.NEW_DATE DESC) AS [ROWNUMBER], B.*
				, (SELECT [APP_NAME] FROM EDI_APPROVAL WHERE EDI_CODE = A.EDI_CODE AND APP_STATUS = ''N'') AS [APP_NAME]
				, ISNULL((SELECT TOP 1 READ_YN FROM EDI_APPROVAL WHERE EDI_CODE = A.EDI_CODE AND APP_CODE = ''' + @EMP_CODE + ''' ORDER BY SEQ_NO DESC), ''Y'') AS [READ_YN]
			FROM
			(
				SELECT A.EDI_CODE
				FROM EDI_MASTER_DAMO A
				WHERE EDI_STATUS = ''1'' AND NEW_CODE = ''' + @EMP_CODE + ''' AND VIEW_YN = ''Y''
				--#검색조건
				UNION
				SELECT A.EDI_CODE
				FROM EDI_MASTER_DAMO A
				INNER JOIN EDI_APPROVAL B ON A.EDI_CODE = B.EDI_CODE
				WHERE A.EDI_STATUS = ''1'' AND B.APP_CODE = ''' + @EMP_CODE + ''' AND B.APP_STATUS = ''Y'' AND B.VIEW_YN = ''Y''
				--#검색조건
			) A
			INNER JOIN EDI_MASTER_DAMO B ON A.EDI_CODE = B.EDI_CODE
		)
		SELECT *,
			(SELECT COUNT(*) FROM EDI_COMMENT WHERE EDI_CODE = A.EDI_CODE) AS [COMMENT_COUNT]
		FROM DOCUMENTLIST A
		WHERE ROWNUMBER BETWEEN ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + 1)) + ' AND ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + @PAGESIZE)) + '
		ORDER BY A.EDI_CODE DESC;'
	END
	ELSE IF @FLAG = '31'			-- 일반완료문서함		자신이 작성자 또는 결재자이고 완료인 일반문서
	BEGIN
		SET @QUERY = '
		SELECT COUNT(*) FROM
		(
			SELECT EDI_CODE FROM EDI_MASTER_DAMO A
			WHERE EDI_STATUS = ''3'' AND DOC_TYPE NOT IN (''4'', ''8'') AND VIEW_YN = ''Y''
			AND NEW_CODE = ''' + @EMP_CODE + '''
			--#검색조건
			UNION
			SELECT A.EDI_CODE FROM EDI_MASTER_DAMO A
			INNER JOIN EDI_APPROVAL B ON A.EDI_CODE = B.EDI_CODE
			WHERE A.EDI_STATUS = ''3'' AND A.DOC_TYPE NOT IN (''4'', ''8'')
			AND B.APP_CODE = ''' + @EMP_CODE + ''' AND B.APP_STATUS = ''Y'' AND B.VIEW_YN = ''Y''
			--#검색조건
		) A'
	END
	ELSE IF @FLAG = '32'
	BEGIN
		SET @QUERY = '
		WITH DOCUMENTLIST AS
		(
			SELECT ROW_NUMBER() OVER (ORDER BY A.EDI_CODE DESC) AS [ROWNUMBER], B.*
				, (SELECT [APP_NAME] FROM EDI_APPROVAL WHERE EDI_CODE = A.EDI_CODE AND APP_STATUS = ''N'') AS [APP_NAME]
				, ISNULL((SELECT TOP 1 READ_YN FROM EDI_APPROVAL WHERE EDI_CODE = A.EDI_CODE AND APP_CODE = ''' + @EMP_CODE + ''' ORDER BY SEQ_NO DESC), ''Y'') AS [READ_YN]
			FROM
			(
				SELECT A.EDI_CODE
				FROM EDI_MASTER_DAMO A
				WHERE EDI_STATUS = ''3'' AND DOC_TYPE NOT IN (''4'', ''8'') AND VIEW_YN = ''Y''
				AND NEW_CODE = ''' + @EMP_CODE + '''
				--#검색조건
				UNION
				SELECT A.EDI_CODE
				FROM EDI_MASTER_DAMO A
				INNER JOIN EDI_APPROVAL B ON A.EDI_CODE = B.EDI_CODE
				WHERE A.EDI_STATUS = ''3'' AND A.DOC_TYPE NOT IN (''4'', ''8'')
				AND B.APP_CODE = ''' + @EMP_CODE + ''' AND B.APP_STATUS = ''Y'' AND B.VIEW_YN = ''Y''
				--#검색조건
			) A
			INNER JOIN EDI_MASTER_DAMO B ON A.EDI_CODE = B.EDI_CODE
		)
		SELECT *,
			(SELECT COUNT(*) FROM EDI_COMMENT WHERE EDI_CODE = A.EDI_CODE) AS [COMMENT_COUNT]
		FROM DOCUMENTLIST A
		WHERE ROWNUMBER BETWEEN ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + 1)) + ' AND ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + @PAGESIZE)) + '
		ORDER BY A.EDI_CODE DESC;'
	END
	ELSE IF @FLAG = '41'			-- 일반지결완료문서함		자신이 작성자 또는 결재자이고 완료인 지결문서
	BEGIN
		SET @QUERY = '
		SELECT COUNT(*) FROM
		(
			SELECT EDI_CODE FROM EDI_MASTER_DAMO A
			WHERE EDI_STATUS = ''3'' AND DOC_TYPE = ''4'' AND VIEW_YN = ''Y''
			AND NEW_CODE = ''' + @EMP_CODE + '''
			--#검색조건
			UNION
			SELECT A.EDI_CODE FROM EDI_MASTER_DAMO A
			INNER JOIN EDI_APPROVAL B ON A.EDI_CODE = B.EDI_CODE
			WHERE A.EDI_STATUS = ''3'' AND A.DOC_TYPE = ''4''
			AND B.APP_CODE = ''' + @EMP_CODE + ''' AND B.APP_STATUS = ''Y'' AND B.VIEW_YN = ''Y''
			--#검색조건
		) A'
	END
	ELSE IF @FLAG = '42'
	BEGIN
		SET @QUERY = '
		WITH DOCUMENTLIST AS
		(
			SELECT ROW_NUMBER() OVER (ORDER BY A.EDI_CODE DESC) AS [ROWNUMBER], B.*
				, (SELECT [APP_NAME] FROM EDI_APPROVAL WHERE EDI_CODE = A.EDI_CODE AND APP_STATUS = ''N'') AS [APP_NAME]
				, ISNULL((SELECT TOP 1 READ_YN FROM EDI_APPROVAL WHERE EDI_CODE = A.EDI_CODE AND APP_CODE = ''' + @EMP_CODE + ''' ORDER BY SEQ_NO DESC), ''Y'') AS [READ_YN]
			FROM
			(
				SELECT A.EDI_CODE
				FROM EDI_MASTER_DAMO A
				WHERE EDI_STATUS = ''3'' AND DOC_TYPE = ''4'' AND VIEW_YN = ''Y''
				AND NEW_CODE = ''' + @EMP_CODE + '''
				--#검색조건
				UNION
				SELECT A.EDI_CODE
				FROM EDI_MASTER_DAMO A
				INNER JOIN EDI_APPROVAL B ON A.EDI_CODE = B.EDI_CODE
				WHERE A.EDI_STATUS = ''3'' AND A.DOC_TYPE = ''4''
				AND B.APP_CODE = ''' + @EMP_CODE + ''' AND B.APP_STATUS = ''Y'' AND B.VIEW_YN = ''Y''
				--#검색조건
			) A
			INNER JOIN EDI_MASTER_DAMO B ON A.EDI_CODE = B.EDI_CODE
		)
		SELECT *,
			(SELECT COUNT(*) FROM EDI_COMMENT WHERE EDI_CODE = A.EDI_CODE) AS [COMMENT_COUNT]
		FROM DOCUMENTLIST A
		WHERE ROWNUMBER BETWEEN ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + 1)) + ' AND ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + @PAGESIZE)) + '
		ORDER BY A.EDI_CODE DESC;'
	END
	ELSE IF @FLAG = '51'			-- 일반지결완료문서함		자신이 작성자 또는 결재자이고 완료인 지결문서
	BEGIN
		SET @QUERY = '
		SELECT COUNT(*) FROM
		(
			SELECT EDI_CODE FROM EDI_MASTER_DAMO A
			WHERE EDI_STATUS = ''3'' AND DOC_TYPE = ''8'' AND VIEW_YN = ''Y''
			AND NEW_CODE = ''' + @EMP_CODE + '''
			--#검색조건
			UNION
			SELECT A.EDI_CODE FROM EDI_MASTER_DAMO A
			INNER JOIN EDI_APPROVAL B ON A.EDI_CODE = B.EDI_CODE
			WHERE A.EDI_STATUS = ''3'' AND A.DOC_TYPE = ''8''
			AND B.APP_CODE = ''' + @EMP_CODE + ''' AND B.APP_STATUS = ''Y'' AND B.VIEW_YN = ''Y''
			--#검색조건
			UNION
			SELECT A.EDI_CODE FROM EDI_MASTER_DAMO A WITH(NOLOCK)
			INNER JOIN EMP_MASTER_damo B WITH(NOLOCK) ON A.NEW_CODE = B.EMP_CODE
			WHERE A.EDI_STATUS = ''3'' AND A.DOC_TYPE = ''8''
			AND B.TEAM_CODE IN (SELECT TEAM_CODE FROM EMP_GROUP_DETAIL WITH(NOLOCK) WHERE GROUP_CODE IN (' + @GROUP_CODES + '))
			--#검색조건
		) A'
	END
	ELSE IF @FLAG = '52'
	BEGIN
		SET @QUERY = '
		WITH DOCUMENTLIST AS
		(
			SELECT ROW_NUMBER() OVER (ORDER BY A.EDI_CODE DESC) AS [ROWNUMBER], B.*
				, (SELECT [APP_NAME] FROM EDI_APPROVAL WHERE EDI_CODE = A.EDI_CODE AND APP_STATUS = ''N'') AS [APP_NAME]
				, ISNULL((SELECT TOP 1 READ_YN FROM EDI_APPROVAL WHERE EDI_CODE = A.EDI_CODE AND APP_CODE = ''' + @EMP_CODE + ''' ORDER BY SEQ_NO DESC), ''Y'') AS [READ_YN]
			FROM
			(
				SELECT A.EDI_CODE
				FROM EDI_MASTER_DAMO A
				WHERE EDI_STATUS = ''3'' AND DOC_TYPE = ''8'' AND VIEW_YN = ''Y''
				AND NEW_CODE = ''' + @EMP_CODE + '''
				--#검색조건
				UNION
				SELECT A.EDI_CODE
				FROM EDI_MASTER_DAMO A
				INNER JOIN EDI_APPROVAL B ON A.EDI_CODE = B.EDI_CODE
				WHERE A.EDI_STATUS = ''3'' AND A.DOC_TYPE = ''8''
				AND B.APP_CODE = ''' + @EMP_CODE + ''' AND B.APP_STATUS = ''Y'' AND B.VIEW_YN = ''Y''
				--#검색조건
				UNION
				SELECT A.EDI_CODE FROM EDI_MASTER_DAMO A WITH(NOLOCK)
				INNER JOIN EMP_MASTER_damo B WITH(NOLOCK) ON A.NEW_CODE = B.EMP_CODE
				WHERE A.EDI_STATUS = ''3'' AND A.DOC_TYPE = ''8''
				AND B.TEAM_CODE IN (SELECT TEAM_CODE FROM EMP_GROUP_DETAIL WITH(NOLOCK) WHERE GROUP_CODE IN (' + @GROUP_CODES + '))
				--#검색조건
			) A
			INNER JOIN EDI_MASTER_DAMO B ON A.EDI_CODE = B.EDI_CODE
		)
		SELECT *,
			(SELECT COUNT(*) FROM EDI_COMMENT WHERE EDI_CODE = A.EDI_CODE) AS [COMMENT_COUNT]
		FROM DOCUMENTLIST A
		WHERE ROWNUMBER BETWEEN ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + 1)) + ' AND ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + @PAGESIZE)) + '
		ORDER BY A.EDI_CODE DESC;'
	END
	ELSE IF @FLAG = '53'			-- 행사지결완료문서함		재무회계팀전용
	BEGIN
		SET @QUERY = '
		SELECT *, ROW_NUMBER() OVER (ORDER BY A.EDI_CODE DESC) AS [ROWNUMBER]
			, (SELECT COUNT(*) FROM EDI_COMMENT WHERE EDI_CODE = A.EDI_CODE) AS [COMMENT_COUNT]
			, ISNULL((SELECT TOP 1 READ_YN FROM EDI_APPROVAL
				WHERE EDI_CODE = A.EDI_CODE AND APP_CODE = ''' + @EMP_CODE + ''' ORDER BY SEQ_NO DESC), ''Y'') AS [READ_YN]
		FROM
		(
			SELECT A.EDI_CODE, (SELECT KOR_NAME FROM AGT_MASTER WHERE AGT_CODE = A.AGT_CODE) AS [AGT_NAME]
			FROM EDI_MASTER_DAMO A
			WHERE DOC_TYPE = ''8'' AND EDI_STATUS = ''3'' AND VIEW_YN = ''Y''
			AND NEW_CODE = ''' + @EMP_CODE + '''
			--#검색조건
			UNION
			SELECT A.EDI_CODE, (SELECT KOR_NAME FROM AGT_MASTER WHERE AGT_CODE = A.AGT_CODE) AS [AGT_NAME]
			FROM EDI_MASTER_DAMO A
			INNER JOIN EDI_APPROVAL B ON A.EDI_CODE = B.EDI_CODE
			WHERE DOC_TYPE = ''8'' AND EDI_STATUS = ''3''
			AND B.APP_CODE = ''' + @EMP_CODE + ''' AND B.APP_STATUS = ''Y'' AND B.VIEW_YN = ''Y''
			--#검색조건
		) A
		INNER JOIN EDI_MASTER_DAMO B ON A.EDI_CODE = B.EDI_CODE
		ORDER BY A.EDI_CODE DESC;'
	END
	ELSE IF @FLAG = '61'			-- 일반재검토문서함		자신이 작성자 또는 결재자이고 반려인 일반문서
	BEGIN
		SET @QUERY = '
		SELECT COUNT(*) FROM
		(
			SELECT EDI_CODE FROM EDI_MASTER_DAMO A
			WHERE A.EDI_STATUS = ''2'' AND A.DOC_TYPE IN (''1'', ''2'', ''3'', ''5'', ''6'', ''7'')
			AND A.NEW_CODE = ''' + @EMP_CODE + ''' AND A.VIEW_YN = ''Y''
			--#검색조건
			UNION
			SELECT A.EDI_CODE FROM EDI_MASTER_DAMO A
			INNER JOIN EDI_APPROVAL B ON A.EDI_CODE = B.EDI_CODE
			WHERE A.EDI_STATUS = ''2'' AND A.DOC_TYPE IN (''1'', ''2'', ''3'', ''5'', ''6'', ''7'')
			AND B.APP_CODE = ''' + @EMP_CODE + ''' AND B.APP_STATUS = ''Y'' AND B.VIEW_YN = ''Y''
			--#검색조건
		) A'
	END
	ELSE IF @FLAG = '62'
	BEGIN
		SET @QUERY = '
		WITH DOCUMENTLIST AS
		(
			SELECT ROW_NUMBER() OVER (ORDER BY A.EDI_CODE DESC) AS [ROWNUMBER], B.*
				, (SELECT [APP_NAME] FROM EDI_APPROVAL WHERE EDI_CODE = A.EDI_CODE AND APP_STATUS = ''N'') AS [APP_NAME]
				, ISNULL((SELECT TOP 1 READ_YN FROM EDI_APPROVAL WHERE EDI_CODE = A.EDI_CODE AND APP_CODE = ''' + @EMP_CODE + ''' ORDER BY SEQ_NO DESC), ''Y'') AS [READ_YN]
			FROM
			(
				SELECT A.EDI_CODE
				FROM EDI_MASTER_DAMO A
				WHERE EDI_STATUS = ''2'' AND A.DOC_TYPE IN (''1'', ''2'', ''3'', ''5'', ''6'', ''7'')
				AND NEW_CODE = ''' + @EMP_CODE + ''' AND A.VIEW_YN = ''Y''
				--#검색조건
				UNION
				SELECT A.EDI_CODE
				FROM EDI_MASTER_DAMO A
				INNER JOIN EDI_APPROVAL B ON A.EDI_CODE = B.EDI_CODE
				WHERE A.EDI_STATUS = ''2'' AND A.DOC_TYPE IN (''1'', ''2'', ''3'', ''5'', ''6'', ''7'')
				AND B.APP_CODE = ''' + @EMP_CODE + ''' AND B.APP_STATUS = ''Y'' AND B.VIEW_YN = ''Y''
				--#검색조건
			) A
			INNER JOIN EDI_MASTER_DAMO B ON A.EDI_CODE = B.EDI_CODE
		)
		SELECT *,
			(SELECT COUNT(*) FROM EDI_COMMENT WHERE EDI_CODE = A.EDI_CODE) AS [COMMENT_COUNT]
		FROM DOCUMENTLIST A
		WHERE ROWNUMBER BETWEEN ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + 1)) + ' AND ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + @PAGESIZE)) + '
		ORDER BY A.EDI_CODE DESC;'
	END
	ELSE IF @FLAG = '71'			-- 일반지결재검토문서함		자신이 작성자 또는 결재자이고 반려인 지결문서
	BEGIN
		SET @QUERY = '
		SELECT COUNT(*) FROM
		(
			SELECT EDI_CODE FROM EDI_MASTER_DAMO A
			WHERE EDI_STATUS = ''2'' AND DOC_TYPE = ''4'' AND VIEW_YN = ''Y''
			AND NEW_CODE = ''' + @EMP_CODE + '''
			--#검색조건
			UNION
			SELECT A.EDI_CODE FROM EDI_MASTER_DAMO A
			INNER JOIN EDI_APPROVAL B ON A.EDI_CODE = B.EDI_CODE
			WHERE A.EDI_STATUS = ''2'' AND A.DOC_TYPE = ''4''
			AND B.APP_CODE = ''' + @EMP_CODE + ''' AND B.APP_STATUS = ''Y'' AND B.VIEW_YN = ''Y''
			--#검색조건
		) A'
	END
	ELSE IF @FLAG = '72'
	BEGIN
		SET @QUERY = '
		WITH DOCUMENTLIST AS
		(
			SELECT ROW_NUMBER() OVER (ORDER BY A.EDI_CODE DESC) AS [ROWNUMBER], B.*
				, (SELECT [APP_NAME] FROM EDI_APPROVAL WHERE EDI_CODE = A.EDI_CODE AND APP_STATUS = ''N'') AS [APP_NAME]
				, ISNULL((SELECT TOP 1 READ_YN FROM EDI_APPROVAL WHERE EDI_CODE = A.EDI_CODE AND APP_CODE = ''' + @EMP_CODE + ''' ORDER BY SEQ_NO DESC), ''Y'') AS [READ_YN]
			FROM
			(
				SELECT A.EDI_CODE
				FROM EDI_MASTER_DAMO A
				WHERE EDI_STATUS = ''2'' AND DOC_TYPE = ''4'' AND VIEW_YN = ''Y''
				AND NEW_CODE = ''' + @EMP_CODE + '''
				--#검색조건
				UNION
				SELECT A.EDI_CODE
				FROM EDI_MASTER_DAMO A
				INNER JOIN EDI_APPROVAL B ON A.EDI_CODE = B.EDI_CODE
				WHERE A.EDI_STATUS = ''2'' AND A.DOC_TYPE = ''4''
				AND B.APP_CODE = ''' + @EMP_CODE + ''' AND B.APP_STATUS = ''Y'' AND B.VIEW_YN = ''Y''
				--#검색조건
			) A
			INNER JOIN EDI_MASTER_DAMO B ON A.EDI_CODE = B.EDI_CODE
		)
		SELECT *,
			(SELECT COUNT(*) FROM EDI_COMMENT WHERE EDI_CODE = A.EDI_CODE) AS [COMMENT_COUNT]
		FROM DOCUMENTLIST A
		WHERE ROWNUMBER BETWEEN ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + 1)) + ' AND ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + @PAGESIZE)) + '
		ORDER BY A.EDI_CODE DESC;'
	END
	ELSE IF @FLAG = '81'			-- 행사결재검토문서함		자신이 작성자 또는 결재자이고 반려인 지결문서
	BEGIN
		SET @QUERY = '
		SELECT COUNT(*) FROM
		(
			SELECT EDI_CODE FROM EDI_MASTER_DAMO A
			WHERE EDI_STATUS = ''2'' AND DOC_TYPE = ''8'' AND VIEW_YN = ''Y''
			AND NEW_CODE = ''' + @EMP_CODE + '''
			--#검색조건
			UNION
			SELECT A.EDI_CODE FROM EDI_MASTER_DAMO A
			INNER JOIN EDI_APPROVAL B ON A.EDI_CODE = B.EDI_CODE
			WHERE A.EDI_STATUS = ''2'' AND A.DOC_TYPE = ''8''
			AND B.APP_CODE = ''' + @EMP_CODE + ''' AND B.APP_STATUS = ''Y'' AND B.VIEW_YN = ''Y''
			--#검색조건
		) A'
	END
	ELSE IF @FLAG = '82'
	BEGIN
		SET @QUERY = '
		WITH DOCUMENTLIST AS
		(
			SELECT ROW_NUMBER() OVER (ORDER BY A.EDI_CODE DESC) AS [ROWNUMBER], B.*
				, (SELECT [APP_NAME] FROM EDI_APPROVAL WHERE EDI_CODE = A.EDI_CODE AND APP_STATUS = ''N'') AS [APP_NAME]
				, ISNULL((SELECT TOP 1 READ_YN FROM EDI_APPROVAL WHERE EDI_CODE = A.EDI_CODE AND APP_CODE = ''' + @EMP_CODE + ''' ORDER BY SEQ_NO DESC), ''Y'') AS [READ_YN]
			FROM
			(
				SELECT A.EDI_CODE
				FROM EDI_MASTER_DAMO A
				WHERE EDI_STATUS = ''2'' AND DOC_TYPE = ''8'' AND VIEW_YN = ''Y''
				AND NEW_CODE = ''' + @EMP_CODE + '''
				--#검색조건
				UNION
				SELECT A.EDI_CODE
				FROM EDI_MASTER_DAMO A
				INNER JOIN EDI_APPROVAL B ON A.EDI_CODE = B.EDI_CODE
				WHERE A.EDI_STATUS = ''2'' AND A.DOC_TYPE = ''8''
				AND B.APP_CODE = ''' + @EMP_CODE + ''' AND B.APP_STATUS = ''Y'' AND B.VIEW_YN = ''Y''
				--#검색조건
			) A
			INNER JOIN EDI_MASTER_DAMO B ON A.EDI_CODE = B.EDI_CODE
		)
		SELECT *,
			(SELECT COUNT(*) FROM EDI_COMMENT WHERE EDI_CODE = A.EDI_CODE) AS [COMMENT_COUNT]
		FROM DOCUMENTLIST A
		WHERE ROWNUMBER BETWEEN ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + 1)) + ' AND ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + @PAGESIZE)) + '
		ORDER BY A.EDI_CODE DESC;'
	END
	--ELSE IF @FLAG = '82'			-- 행사지결재검토문서함		자신이 작성자 또는 결재자이고 재검토인 지결문서
	--BEGIN
	--	SET @QUERY = '
	--	SELECT *, ROW_NUMBER() OVER (ORDER BY EDI_CODE DESC) AS [ROWNUMBER]
	--		, (SELECT COUNT(*) FROM EDI_COMMENT WHERE EDI_CODE = A.EDI_CODE) AS [COMMENT_COUNT]
	--	FROM
	--	(
	--		SELECT A.*, ''Y'' AS [READ_YN], VIEW_YN AS [VIEW_YN_2]
	--			, (SELECT KOR_NAME FROM AGT_MASTER WHERE AGT_CODE = A.AGT_CODE) AS [AGT_NAME]
	--		FROM EDI_MASTER_DAMO A
	--		WHERE DOC_TYPE = ''8'' AND EDI_STATUS = ''2''
	--		AND NEW_CODE = ''' + @EMP_CODE + '''
	--		--#검색조건
	--		UNION
	--		SELECT A.*, B.READ_YN AS [READ_YN], B.VIEW_YN AS [VIEW_YN_2]
	--			, (SELECT KOR_NAME FROM AGT_MASTER WHERE AGT_CODE = A.AGT_CODE) AS [AGT_NAME]
	--		FROM EDI_MASTER_DAMO A
	--		INNER JOIN EDI_APPROVAL B ON A.EDI_CODE = B.EDI_CODE
	--		WHERE DOC_TYPE = ''8'' AND EDI_STATUS = ''2''
	--		AND B.APP_CODE = ''' + @EMP_CODE + ''' AND B.APP_STATUS = ''Y''
	--		--#검색조건
	--	) A
	--	WHERE VIEW_YN_2 = ''Y'';'
	--END
	ELSE IF @FLAG = '91'			--참고함				참조자에 포함되어 있는 모든 문서
	BEGIN
		SET @QUERY = '
		SELECT COUNT(*) FROM EDI_REFERENCE A
		INNER JOIN EDI_MASTER_DAMO B ON A.EDI_CODE = B.EDI_CODE
		WHERE A.REF_CODE = ''' + @EMP_CODE + ''' AND B.VIEW_YN = ''Y''
		--#검색조건'
	END
	ELSE IF @FLAG = '92'
	BEGIN
		SET @QUERY = '
		WITH DOCUMENTLIST AS
		(
			SELECT
				ROW_NUMBER() OVER (ORDER BY B.EDI_CODE DESC) AS [ROWNUMBER],
				(
					SELECT [APP_NAME] FROM EDI_APPROVAL
					WHERE EDI_CODE = A.EDI_CODE AND APP_STATUS = ''N''
				) AS [APP_NAME], A.READ_YN,
				B.*
			FROM EDI_REFERENCE A
			INNER JOIN EDI_MASTER_DAMO B ON A.EDI_CODE = B.EDI_CODE
			WHERE A.REF_CODE = ''' + @EMP_CODE + ''' AND B.VIEW_YN = ''Y''
			--#검색조건
		)
		SELECT *,
			(SELECT COUNT(*) FROM EDI_COMMENT WHERE EDI_CODE = A.EDI_CODE) AS [COMMENT_COUNT]
		FROM DOCUMENTLIST A
		WHERE ROWNUMBER BETWEEN ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + 1)) + ' AND ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + @PAGESIZE)) + '
		ORDER BY A.EDI_CODE DESC;'
	END
	ELSE IF @FLAG = '101'			--부서수신문서함
	BEGIN
		SET @QUERY = '
		SELECT COUNT(*) 
		FROM EDI_MASTER_DAMO A
		WHERE EDI_STATUS = ''3'' AND RCV_TEAM_CODE IN (' + @GROUP_CODES + ')
		--#검색조건'

	END
	ELSE IF @FLAG = '102'			--부서수신함
	BEGIN
		SET @QUERY = '
		WITH DOCUMENTLIST AS
		(
			SELECT
				ROW_NUMBER() OVER (ORDER BY A.EDI_CODE DESC) AS [ROWNUMBER],
				*
			FROM EDI_MASTER_DAMO A
			WHERE EDI_STATUS = ''3'' AND RCV_TEAM_CODE IN (' + @GROUP_CODES + ')
			--#검색조건
		)
		SELECT *, ''Y'' AS [READ_YN],
			(SELECT COUNT(*) FROM EDI_COMMENT WHERE EDI_CODE = A.EDI_CODE) AS [COMMENT_COUNT]
		FROM DOCUMENTLIST A
		WHERE ROWNUMBER BETWEEN ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + 1)) + ' AND ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + @PAGESIZE)) + '
		ORDER BY A.EDI_CODE DESC;'

	END
	ELSE IF @FLAG = '111'				--관리팀대기함
	BEGIN
		SET @QUERY = '-- DOC_TYPE:4(일반지결)8(행사지결), EDI_STATUS:1(진행중), APP_TYPE:2(회계라인)
		WITH DOCUMENTLIST AS
		(
			SELECT * 
			FROM EDI_MASTER_DAMO A
			WHERE A.DOC_TYPE IN (''4'', ''8'') AND A.EDI_STATUS = ''1'' AND A.APP_TYPE = ''2''
			--#검색조건
		)
		SELECT COUNT(*) FROM DOCUMENTLIST A
		WHERE EDI_CODE NOT IN (
			SELECT A.EDI_CODE FROM DOCUMENTLIST A
			INNER JOIN EDI_APPROVAL B ON A.EDI_CODE = B.EDI_CODE
			WHERE B.APP_TYPE = ''2''
		) AND A.RCV_TEAM_CODE IN (' + @GROUP_CODES + ');'
	END
	ELSE IF @FLAG = '112'
	BEGIN
		SET @QUERY = '
		-- DOC_TYPE:4(지결)8(행사지결), EDI_STATUS:1(진행중), APP_TYPE:2(회계라인)
		WITH DOCUMENTLIST AS
		(
			SELECT
				ROW_NUMBER() OVER (ORDER BY APP_DATE) AS [ROWNUMBER],
				*
			FROM
			(
				SELECT A.*,
					(SELECT MAX(APP_DATE) FROM EDI_APPROVAL WHERE EDI_CODE = A.EDI_CODE AND APP_TYPE IN (1, 3)) AS [APP_DATE]
				FROM EDI_MASTER_DAMO A
				WHERE DOC_TYPE IN (''4'', ''8'') AND EDI_STATUS = ''1'' AND APP_TYPE = ''2''
				--#검색조건
			) A
			WHERE EDI_CODE NOT IN
			(
				SELECT A.EDI_CODE FROM
				(
					SELECT * 
					FROM EDI_MASTER_DAMO
					WHERE DOC_TYPE IN (''4'', ''8'') AND EDI_STATUS = ''1'' AND APP_TYPE = ''2''
				) A
				INNER JOIN EDI_APPROVAL B ON A.EDI_CODE = B.EDI_CODE
				WHERE B.APP_TYPE = ''2''
			) AND RCV_TEAM_CODE IN (' + @GROUP_CODES + ')
		)
		SELECT *, ''Y'' AS [READ_YN],
			(SELECT COUNT(*) FROM EDI_COMMENT WHERE EDI_CODE = A.EDI_CODE) AS [COMMENT_COUNT]
		FROM DOCUMENTLIST A
		WHERE ROWNUMBER BETWEEN ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + 1)) + ' AND ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + @PAGESIZE)) + '
		ORDER BY APP_DATE;'
	END
	ELSE IF @FLAG = '121'				--경영지원실대기함
	BEGIN
		SET @QUERY = '
		-- DOC_TYPE:6(발권요청)7(기안)8(행사지결), EDI_STATUS:1(진행중), APP_TYPE:3(경영지원라인)
		SELECT COUNT(*) FROM (
			SELECT A.EDI_CODE, ISNULL(MAX(B.APP_TYPE), 1) AS [APP_TYPE]
			FROM EDI_MASTER_DAMO A
			LEFT JOIN EDI_APPROVAL B ON A.EDI_CODE = B.EDI_CODE
			WHERE A.EDI_STATUS = ''1'' AND A.APP_TYPE = ''3''
			AND EXISTS (SELECT 1 FROM EMP_MASTER_damo WHERE EMP_CODE = ''' + @EMP_CODE + ''' AND TEAM_CODE IN (' + @GROUP_CODES + ') AND WORK_TYPE = ''1'')
			--#검색조건
			GROUP BY A.EDI_CODE
		) A 
		WHERE APP_TYPE = ''1'' OR APP_TYPE = ''4''
		'
	END
	ELSE IF @FLAG = '122'
	BEGIN
		SET @QUERY = '
		-- DOC_TYPE:6(발권요청)7(기안)8(행사지결), EDI_STATUS:1(진행중), APP_TYPE:3(경영지원라인)
		WITH DOCUMENTLIST AS
		(
			SELECT ROW_NUMBER() OVER (ORDER BY A.APP_DATE) AS [ROWNUMBER], *
			FROM (
				SELECT A.EDI_CODE, MAX(B.APP_DATE) AS [APP_DATE], ISNULL(MAX(B.APP_TYPE), 1) AS [APP_TYPE]
				FROM EDI_MASTER_DAMO A
				LEFT JOIN EDI_APPROVAL B ON A.EDI_CODE = B.EDI_CODE
				WHERE A.EDI_STATUS = ''1'' AND A.APP_TYPE = ''3''
				AND EXISTS (SELECT 1 FROM EMP_MASTER_damo WHERE EMP_CODE = ''' + @EMP_CODE + ''' AND TEAM_CODE IN (' + @GROUP_CODES + ') AND WORK_TYPE = ''1'')
				--#검색조건
				GROUP BY A.EDI_CODE
			) A 
			WHERE APP_TYPE = ''1'' OR APP_TYPE = ''4''
		)
		SELECT B.*, ''Y'' AS [READ_YN],
			(SELECT COUNT(*) FROM EDI_COMMENT WHERE EDI_CODE = A.EDI_CODE) AS [COMMENT_COUNT]
		FROM DOCUMENTLIST A
		INNER JOIN EDI_MASTER_DAMO B ON A.EDI_CODE = B.EDI_CODE
		WHERE ROWNUMBER BETWEEN ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + 1)) + ' AND ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + @PAGESIZE)) + '
		ORDER BY A.EDI_CODE DESC;'
	END
	/*
	ELSE IF @FLAG = '131'			--행사문서수신함 (사용 X)
	BEGIN
		IF ((SELECT ISNULL(GROUP_CODE, '') FROM EMP_MASTER_damo WHERE EMP_CODE = @EMP_CODE) = '')
		BEGIN
			SET @QUERY = '
			SELECT COUNT(*) FROM EDI_MASTER_DAMO A
			INNER JOIN PKG_DETAIL B ON A.PRO_CODE = B.PRO_CODE
			WHERE EDI_STATUS = ''3'' AND RCV_TEAM_CODE IN (
			SELECT TEAM_CODE FROM EMP_MASTER_damo WHERE EMP_CODE = ''' + @EMP_CODE + ''')
			--#검색조건'
		END
		ELSE
		BEGIN
			WITH GROUP_LIST AS
			(
				SELECT GROUP_CODE, PARENT_CODE, 0 AS [DEPTH] FROM EMP_GROUP_MASTER
				WHERE GROUP_CODE LIKE
				(
					SELECT (GROUP_CODE + '_') FROM EMP_MASTER
					WHERE EMP_CODE = @EMP_CODE
				)
				UNION ALL
				SELECT A.GROUP_CODE, A.PARENT_CODE, B.DEPTH + 1
				FROM EMP_GROUP_MASTER A
				INNER JOIN GROUP_LIST B ON A.PARENT_CODE = B.GROUP_CODE
			)
			SELECT
				@GROUP_CODES = (STUFF ((SELECT (', ''' + GROUP_CODE + '''') AS [text()] FROM GROUP_LIST FOR XML PATH('')), 1, 2, ''))

			SET @QUERY = 
			'SELECT COUNT(*) FROM EDI_MASTER_DAMO A
			INNER JOIN PKG_DETAIL B ON A.PRO_CODE = B.PRO_CODE
			WHERE RCV_TEAM_CODE IN 
			(
				SELECT TEAM_CODE FROM EMP_GROUP_DETAIL
				WHERE GROUP_CODE IN (' + @GROUP_CODES + ')
			) AND EDI_STATUS = ''3''
			--#검색조건'

		END
	END
	ELSE IF @FLAG = '132'			--행사문서수신함 (사용 X)
	BEGIN
		IF ((SELECT ISNULL(GROUP_CODE, '') FROM EMP_MASTER_damo WHERE EMP_CODE = @EMP_CODE) = '')
		BEGIN
			SET @QUERY = '
			WITH DOCUMENTLIST AS
			(
				SELECT
					ROW_NUMBER() OVER (ORDER BY A.EDI_CODE DESC) AS [ROWNUMBER],
					A.*
				FROM EDI_MASTER_DAMO A
				INNER JOIN PKG_DETAIL B ON A.PRO_CODE = B.PRO_CODE
				WHERE EDI_STATUS = ''3'' AND RCV_TEAM_CODE IN
				(
					SELECT TEAM_CODE FROM EMP_MASTER_damo WHERE EMP_CODE = ''' + @EMP_CODE + '''
				)
				--#검색조건
			)
			SELECT *, ''Y'' AS [READ_YN],
				(SELECT COUNT(*) FROM EDI_COMMENT WHERE EDI_CODE = A.EDI_CODE) AS [COMMENT_COUNT]
			FROM DOCUMENTLIST A
			WHERE ROWNUMBER BETWEEN ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + 1)) + ' AND ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + @PAGESIZE)) + ';'
		END
		ELSE
		BEGIN
			WITH GROUP_LIST AS
			(
				SELECT GROUP_CODE, PARENT_CODE, 0 AS [DEPTH] FROM EMP_GROUP_MASTER
				WHERE GROUP_CODE LIKE
				(
					SELECT (GROUP_CODE + '_') FROM EMP_MASTER
					WHERE EMP_CODE = @EMP_CODE
				)
				UNION ALL
				SELECT A.GROUP_CODE, A.PARENT_CODE, B.DEPTH + 1
				FROM EMP_GROUP_MASTER A
				INNER JOIN GROUP_LIST B ON A.PARENT_CODE = B.GROUP_CODE
			)
			SELECT
				@GROUP_CODES = (STUFF ((SELECT (', ''' + GROUP_CODE + '''') AS [text()] FROM GROUP_LIST FOR XML PATH('')), 1, 2, ''))

			SET @QUERY = '
			WITH DOCUMENTLIST AS
			(
				SELECT
					ROW_NUMBER() OVER (ORDER BY A.EDI_CODE DESC) AS [ROWNUMBER],
					A.*
				FROM EDI_MASTER_DAMO A
				INNER JOIN PKG_DETAIL B ON A.PRO_CODE = B.PRO_CODE
				WHERE RCV_TEAM_CODE IN 
				(
					SELECT TEAM_CODE FROM EMP_GROUP_DETAIL
					WHERE GROUP_CODE IN (' + @GROUP_CODES + ')
				) AND EDI_STATUS = ''3''
				--#검색조건
			)
			SELECT *, ''Y'' AS [READ_YN],
				(SELECT COUNT(*) FROM EDI_COMMENT WHERE EDI_CODE = A.EDI_CODE) AS [COMMENT_COUNT]
			FROM DOCUMENTLIST A
			WHERE ROWNUMBER BETWEEN ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + 1)) + ' AND ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + @PAGESIZE)) + ';'
		END
	END
	*/
	ELSE IF @FLAG = '131'				--CS팀대기함
	BEGIN
		SET @QUERY = '-- DOC_TYPE:9(출장보고서), EDI_STATUS:1(진행중), APP_TYPE:4(출장보고서 라인)
		  SELECT COUNT(*)
			FROM (
				SELECT A.EDI_CODE, MAX(B.APP_DATE) AS [APP_DATE], ISNULL(MAX(B.APP_TYPE), 1) AS [APP_TYPE], MAX(A.NEW_DATE) AS NEW_DATE
				FROM EDI_MASTER_DAMO A
				LEFT JOIN EDI_APPROVAL B ON A.EDI_CODE = B.EDI_CODE
				WHERE A.EDI_STATUS = ''1'' AND A.APP_TYPE = ''4''
				AND EXISTS (SELECT 1 FROM EMP_MASTER_damo WHERE EMP_CODE = ''' + @EMP_CODE + ''' AND TEAM_CODE IN (''540'', ''529''))
				--#검색조건
				GROUP BY A.EDI_CODE
			) A 
			WHERE APP_TYPE = ''1'' '
	END
	ELSE IF @FLAG = '132'				--CS팀대기함
	BEGIN
		SET @QUERY = '-- DOC_TYPE:9(출장보고서), EDI_STATUS:1(진행중), APP_TYPE:4(출장보고서 라인)
		WITH DOCUMENTLIST AS
		(
			SELECT ROW_NUMBER() OVER (ORDER BY A.NEW_DATE) AS [ROWNUMBER], *
			FROM (
				SELECT A.EDI_CODE, MAX(B.APP_DATE) AS [APP_DATE], ISNULL(MAX(B.APP_TYPE), 1) AS [APP_TYPE], MAX(A.NEW_DATE) AS NEW_DATE
				FROM EDI_MASTER_DAMO A
				LEFT JOIN EDI_APPROVAL B ON A.EDI_CODE = B.EDI_CODE
				WHERE A.EDI_STATUS = ''1'' AND A.APP_TYPE = ''4''
				AND EXISTS (SELECT 1 FROM EMP_MASTER_damo WHERE EMP_CODE = ''' + @EMP_CODE + ''' AND TEAM_CODE IN (''540'', ''529''))
				--#검색조건
				GROUP BY A.EDI_CODE
			) A 
			WHERE APP_TYPE = ''1''
		)
		SELECT B.*, ''Y'' AS [READ_YN],
			(SELECT COUNT(*) FROM EDI_COMMENT WHERE EDI_CODE = A.EDI_CODE) AS [COMMENT_COUNT]
		FROM DOCUMENTLIST A
		INNER JOIN EDI_MASTER_DAMO B ON A.EDI_CODE = B.EDI_CODE
		WHERE ROWNUMBER BETWEEN ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + 1)) + ' AND ' + CONVERT(VARCHAR(10), (@IPAGE * @PAGESIZE + @PAGESIZE)) + '
		ORDER BY A.EDI_CODE DESC;'
	END

	IF @WHERE IS NOT NULL
		SET @QUERY = REPLACE(@QUERY, '--#검색조건', @WHERE)

	--PRINT (@QUERY)

	EXEC (@QUERY)
	

END





GO
