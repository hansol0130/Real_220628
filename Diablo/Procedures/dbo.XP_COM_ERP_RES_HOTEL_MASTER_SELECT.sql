USE [Diablo]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*================================================================================================================
■ USP_NAME					: XP_COM_ERP_RES_HOTEL_MASTER_SELECT
■ DESCRIPTION				: BTMS 호텔 예약 마스터 정보 검색
■ INPUT PARAMETER			: 
	@RES_CODE				: 예약코드
■ OUTPUT PARAMETER			: 
■ EXEC						: 

	EXEC XP_COM_ERP_RES_HOTEL_MASTER_SELECT 'RT1604148894';

■ MEMO						: 
------------------------------------------------------------------------------------------------------------------
■ CHANGE HISTORY
------------------------------------------------------------------------------------------------------------------
   DATE				AUTHOR			DESCRIPTION           
------------------------------------------------------------------------------------------------------------------
   2016-04-14		김성호			최초생성
================================================================================================================*/ 
CREATE PROC [dbo].[XP_COM_ERP_RES_HOTEL_MASTER_SELECT]
	@RES_CODE		VARCHAR(20)
AS 
BEGIN
	-- 예약 대표 정보
	EXEC XP_COM_ERP_RES_MASTER_SELECT @RES_CODE;

	-- 호텔 예약정보
	SELECT
		A.RES_CODE, A.GRP_RES_CODE, B.RES_STATE AS HTL_RES_STATE, DBO.FN_RES_HTL_GET_PAY_STATE(A.RES_CODE) AS [PAY_STATE]
		, B.ROOM_YN
		, B.LAST_CXL_DATE
		--, ISNULL((SELECT SET_STATE FROM SET_MASTER WHERE PRO_CODE = A.PRO_CODE), 9) AS [SET_STATE]
		, ISNULL(C.MASTER_NAME, A.PRO_NAME) AS MASTER_NAME
		, B.CHECK_IN, B.CHECK_OUT
		, B.SUP_CODE, B.SUP_RES_CODE , B.CXL_REMARK
		, B.POINT_RATE , B.POINT_PRICE, B.EVENT_SEQ, B.VOUCHER_NO
		, B.MASTER_CODE AS HOTEL_CODE -- 저스트고 호텔CODE 
	FROM RES_MASTER_damo A WITH(NOLOCK)
	LEFT JOIN RES_HTL_ROOM_MASTER B WITH(NOLOCK) ON A.RES_CODE = B.RES_CODE
	LEFT JOIN HTL_MASTER C WITH(NOLOCK) ON B.MASTER_CODE = C.MASTER_CODE
	WHERE A.RES_CODE = @RES_CODE

	-- 룸정보
	SELECT A.ROOM_TYPE, A.ROOM_COUNT, A.ROOM_NAME 
	FROM RES_HTL_ROOM_DETAIL A WITH(NOLOCK)
	WHERE RES_CODE = @RES_CODE

END 


/*

DECLARE @RES_CODE VARCHAR(20) = 'RH1604144491'

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
-- 호텔 예약정보
SELECT
	A.RES_STATE, B.RES_STATE AS HTL_RES_STATE, DBO.FN_RES_HTL_GET_PAY_STATE(A.RES_CODE) AS [PAY_STATE]
	, ROOM_YN  , A.PRO_TYPE, A.RES_CODE, A.GRP_RES_CODE
	, DBO.FN_RES_GET_PAY_PRICE(A.RES_CODE) AS [PAY_PRICE]
	, DBO.FN_RES_HTL_GET_TOTAL_PRICE(A.RES_CODE) AS [TOTAL_PRICE]
	, A.NEW_DATE, A.NEW_CODE, A.EDT_DATE, A.EDT_CODE, A.CXL_DATE, A.CXL_CODE, A.LAST_PAY_DATE
	, (SELECT KOR_NAME FROM EMP_MASTER WHERE EMP_CODE = A.NEW_CODE) AS [NEW_NAME]
	, (SELECT KOR_NAME FROM EMP_MASTER WHERE EMP_CODE = A.EDT_CODE) AS [EDT_NAME]
	, (SELECT KOR_NAME FROM EMP_MASTER WHERE EMP_CODE = A.CXL_CODE) AS [CXL_NAME]
	, B.LAST_CXL_DATE
	, A.RES_NAME 
	, ISNULL((SELECT SET_STATE FROM SET_MASTER WHERE PRO_CODE = A.PRO_CODE), 9) AS [SET_STATE]
	, A.PRO_CODE , A.PRO_NAME, ISNULL(C.MASTER_NAME, A.PRO_NAME) AS MASTER_NAME 
	, B.CHECK_IN, B.CHECK_OUT
	, B.SUP_CODE, B.SUP_RES_CODE , B.CXL_REMARK
	, A.RES_EMAIL
	, B.POINT_RATE , B.POINT_PRICE, B.EVENT_SEQ 
	, B.MASTER_CODE AS HOTEL_CODE -- 저스트고 호텔CODE 
	, A.SALE_COM_CODE 
FROM RES_MASTER_damo A
	LEFT JOIN RES_HTL_ROOM_MASTER B ON A.RES_CODE = B.RES_CODE
	LEFT JOIN HTL_MASTER C ON B.MASTER_CODE = C.MASTER_CODE
WHERE A.RES_CODE = @RES_CODE

SELECT A.ROOM_TYPE, A.ROOM_COUNT, A.ROOM_NAME 
FROM RES_HTL_ROOM_DETAIL A
WHERE RES_CODE = @RES_CODE

*/
GO
