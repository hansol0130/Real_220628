USE [Diablo]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*================================================================================================================
■ USP_NAME					: SP_RES_SND_APP_INFO_INSERT
■ DESCRIPTION				: 앱사용안내 (출발 3일전 일괄 발송)
■ INPUT PARAMETER			: 
■ OUTPUT PARAMETER			: 
■ EXEC						: 

	DECLARE @SEND_COUNT VARCHAR(4000)
	EXEC SP_RES_SND_APP_INFO_INSERT NULL, 'f1e8319931392a3c30bb6fdef415f67ef87aa58c', @SEND_COUNT OUTPUT
	SELECT @SEND_COUNT

	SELECT LEN('801,RP1712266022,RP1801126043,RP1801126115,RP1801172973,RP1801239466,RP1801251569,RP1801263365,RP1802077322,RP1802088578,RP1802133349,RP1802197159,RP1802219807,RP1802219895,RP1802220475,RP1802252841,RP1802275267,RP1803017076,RP1803017099,RP1803027609,RP1803038472,RP1803050725,RP1803059648,RP1803059912,RP1803060955,RP1803061115,RP1803116526,RP1803127550,RP1803128209,RP1803139044,RP1803139100,RP1803139142,RP1803139382,RP1803141427,RP1803152760,RP1803164282,RP1803174436,RP1803196808,RP1803207336,RP1803207423,RP1803220291,RP1803220293,RP1803231934,RP1803232035,RP1803253041,RP1803264214,RP1803264777,RP1803275130,RP1803276077,RP1803286427,RP1803286880,RP1803297848,RP1803308829,RP1804020073,RP1804020583,RP1804020878,RP1804020890,RP1804031354,RP1804031448,RP1804043114,RP1804054178,RP1804054819,RP1804054836,RP1804065133,RP1804065224,RP1804065570,RP1804097165,RP1804097950,RP1804098373,RP1804109620,RP1804111804,RP1804111930,RP1804133966,RP1804154814,RP1804165972,RP1804176581,RP1804187653,RP1804187793,RP1804188132,RP1804199590,RP1804199661,RP1804200605,RP1804231402,RP1804231448,RP1804243550,RP1804243819,RP1804265605,RP1804265698,RP1804266142,RP1804266487,RP1804298205,RP1804309818,RP1805021376,RP1805044031,RP1805054465,RP1805075158,RP1805075274,RP1805097423,RP1805097994,RP1805098200,RP1805108804,RP1805108855,RP1805108895,RP1805109040,RP1805109045,RP1805109508,RP1805110492,RP1805119722,RP1805141992,RP1805142379,RP1805142966,RP1805154200,RP1805165393,RP1805176173,RP1805176703,RP1805187056,RP1805198139,RP1805218796,RP1805219193,RP1805219273,RP1805219393,RP1805219557,RP1805220049,RP1805220105,RP1805220115,RP1805220118,RP1805220121,RP1805230377,RP1805230402,RP1805230434,RP1805231056,RP1805231500,RP1805231528,RP1805231646,RP1805231654,RP1805241857,RP1805242076,RP1805253056,RP1805253140,RP1805253824,RP1805263939,RP1805264063,RP1805264200,RP1805264203,RP1805264220,RP1805274611,RP1805285385,RP1805285455,RP1805296147,RP1805297171,RP1805307719,RP1806019604,RP1806020504,RP1806041096,RP1806041171,RP1806041464,RP1806041578,RP1806041749,RP1806041777,RP1806041857,RP1806042217,RP1806052564,RP1806053136,RP1806053213,RP1806053241,RP1806053527,RP1806053551,RP1806053719,RP1806074469,RP1806074624,RP1806074698,RP1806075345,RP1806085535,RP1806085674,RP1806085840,RP1806085919,RP1806086028,RP1806086118,RP1806086555,RP1806117533,RP1806117652,RP1806117924,RP1806118886,RP1806120164,RP1806129102,RP1806129230,RP1806129524,RP1806129672,RP1806130579,RP1806141150,RP1806141524,RP1806153037,RP1806163141,RP1806173845,RP1806184081,RP1806184087,RP1806184134,RP1806184272,RP1806185082,RP1806185116,RP1806185119,RP1806185120,RP1806185182,RP1806185314,RP1806195648,RP1806195708,RP1806195727,RP1806195927,RP1806196242,RP1806196739,RP1806207790,RP1806207992,RP1806220016,RP1806220045,RP1806229644,RP1806230544,RP1806251122,RP1806251167,RP1806251279,RP1806251403,RP1806251405,RP1806251459,RP1806251542,RP1806252071,RP1806252203,RP1806262622,RP1806262880,RP1806262906,RP1806263434,RP1806273619,RP1806273629,RP1806273731,RP1806273784,RP1806273913,RP1806284746,RP1806285102,RP1806285107,RP1806285122,RP1806285734,RP1806296022,RP1806296141,RP1806296379,RP1806296479,RP1806306879,RP1806307018,RP1807017357,RP1807027633,RP1807027850,RP1807028143,RP1807028484,RP1807028576,RP1807028577,RP1807028685,RP1807030113,RP1807030118,RP1807030189,RP1807030200,RP1807030506,RP1807030526,RP1807030530,RP1807039409,RP1807039635,RP1807040755,RP1807040975,RP1807041107,RP1807041342,RP1807041609,RP1807052138,RP1807052416,RP1807052454,RP1807052557,RP1807052656,RP1807052666,RP1807052748,RP1807052782,RP1807052825,RP1807063282,RP1807063452,RP1807063567,RP1807063845,RP1807063894,RP1807064076,RP1807084799,RP1807084802,RP1807084915,RP1807095231,RP1807095553,RP1807096061,RP1807096332,RP1807096444,RP1807096486,RP1807096519,RP1807106582,RP1807106709,RP1807106797,RP1807107025,RP1807107077,RP1807107184,RP1807107630,RP1807107635,RP1807117850,RP1807117942,RP1807117953,RP1807118238,RP1807118283,RP1807118357,RP1807118553,RP1807118703,RP1807118727,RP1807118859,RP1807118922,RP1807129115,RP1807129272,RP1807129336,RP1807129668,RP1807130318,RP1807130358,RP1807130381,RP1807130621,RP1807130777,RP1807130957,RP1807130979,RP1807131016,RP1807131114,RP1807131258,RP1807141364,RP1807151841,RP1807162592,RP1807162627,RP1807162641,RP1807162737,RP1807162785,RP1807162819,RP1807162891,RP1807162902,RP1807162985,RP1807163061,RP1807163251,RP1807163325,RP1807163345,RP1807163437,RP1807173540,RP1807173861,RP1807173879,RP1807173938,RP1807173967,RP1807174226,RP1807174241,RP1807174248,RP1807174285,RP1807174327,RP1807174438,RP1807174469,RP1807174665,RP1807174698,RP1807184979,RP1807185057,RP1807185097,RP1807185110,RP1807185112,RP1807185135,RP1807185141,RP1807185209,RP1807185256,RP1807185288,RP1807185294,RP1807185308,RP1807185325,RP1807185372,RP1807185430,RP1807185449,RP1807185530,RP1807185577,RP1807185824,RP1807185882,RP1807185907,RP1807185908,RP1807185924,RP1807185931,RP1807185944,RP1807185970,RP1807186000,RP1807196221,RP1807196249,RP1807196254,RP1807196341,RP1807196431,RP1807196467,RP1807196537,RP1807196558,RP1807196582,RP1807196592,RP1807196637,RP1807196659,RP1807196693,RP1807196897,RP1807197006,RP1807197014,RP1807207195,RP1807207476,RP1807207735,RP1807230070,RP1807230263,RP1807230271,RP1807238854,RP1807239137,RP1807240486,RT1807070296,RT1807120534,RT1807120545,RT1807231070')

■ MEMO						: 
------------------------------------------------------------------------------------------------------------------
■ CHANGE HISTORY                   
------------------------------------------------------------------------------------------------------------------
   DATE				AUTHOR			DESCRIPTION           
------------------------------------------------------------------------------------------------------------------
   2018-07-24		김성호			최초생성
================================================================================================================*/ 
CREATE PROC [dbo].[SP_RES_SND_APP_INFO_INSERT]
	@CHECK_DATE		DATETIME = NULL,
	@SENDER_KEY		VARCHAR(40),
	@SEND_COUNT		VARCHAR(4000) OUTPUT
AS 
BEGIN
	-- 발송일시 체크
	IF ISDATE(@CHECK_DATE) < 1	-- 1: 날짜형, 0: 비날짜형
	BEGIN
		SET @CHECK_DATE = DATEADD(DD, 3, GETDATE());
	END

	DECLARE
		@END_DATE DATETIME, @TMPL_CD VARCHAR(20) = 'SYS_AT_0053', -- 사용 템플릿 번호
		@CONTS_TXT VARCHAR(4000), @REQ_DTM VARCHAR(14);

	-- @END_DATE : 검색완료일자, @CHECK_TIME : 체크시간, @CONTS_TXT : 발송문자, @REQ_DTM : 발소일시
	SELECT @END_DATE = DATEADD(DAY, 1, CONVERT(DATE, @CHECK_DATE))
	SELECT @CONTS_TXT = REPLACE(A.CONTS_TXT, '#{예약내역url}', 'http://vgt.kr/u/mV'),
		@REQ_DTM = CONVERT(VARCHAR(8), GETDATE(), 112)
		 + RIGHT(('0' + CONVERT(VARCHAR(2), DATEPART(HH, GETDATE()))), 2)
		 + RIGHT(('0' + CONVERT(VARCHAR(2), DATEPART(MI, GETDATE()))), 2)
		 + RIGHT(('0' + CONVERT(VARCHAR(2), DATEPART(SS, GETDATE()))), 2)
	FROM SEND.dbo.NVMOBILECONTENTS A WITH(NOLOCK)
	WHERE A.KAKAO_TMPL_CD = @TMPL_CD; -- AND A.KAKAO_INSP_STATUS = 'ARP'

	-- 임시테이블 생성
	IF OBJECT_ID('TEMPDB..#ALT_APP_RES_LIST') IS NOT NULL
		DROP TABLE #ALT_APP_RES_LIST;
	CREATE TABLE #ALT_APP_RES_LIST (RES_CODE VARCHAR(12) NOT NULL, SEQ_NO INT NOT NULL, PHONE_NUM VARCHAR(15) NOT NULL, CUS_NO INT);

	WITH RES_LIST AS
	(	-- 패키지
		SELECT A.RES_CODE, B.SEQ_NO, B.CUS_NO, (B.NOR_TEL1 + B.NOR_TEL2 + B.NOR_TEL3) AS [PHONE_NUM]
		FROM RES_MASTER_damo A WITH(NOLOCK)
		INNER LOOP JOIN RES_CUSTOMER_damo B WITH(NOLOCK) ON A.RES_CODE = B.RES_CODE
		INNER JOIN PKG_DETAIL C WITH(NOLOCK) ON A.PRO_CODE = C.PRO_CODE
		INNER JOIN PKG_MASTER D WITH(NOLOCK) ON C.MASTER_CODE = D.MASTER_CODE
		WHERE A.DEP_DATE >= CONVERT(DATE, @CHECK_DATE) AND A.DEP_DATE < @END_DATE AND A.RES_STATE < 7 AND B.RES_STATE = 0 AND A.PRO_TYPE = 1
			AND A.PRO_CODE LIKE '[^K]%' AND D.SIGN_CODE LIKE '[^K]'
			AND D.ATT_CODE IN ('P','R','W','G')  --[마스터 대표속성] 패키지,실시간항공,허니문,골프
			AND C.TRANSFER_TYPE = 1 -- [교통편] 항공편
			AND B.NOR_TEL1 IS NOT NULL AND B.NOR_TEL2 IS NOT NULL AND B.NOR_TEL3 IS NOT NULL
		UNION ALL
		SELECT A.RES_CODE, B.SEQ_NO, B.CUS_NO, (B.NOR_TEL1 + B.NOR_TEL2 + B.NOR_TEL3) AS [PHONE_NUM]
		FROM RES_MASTER_damo A WITH(NOLOCK)
		INNER LOOP JOIN RES_CUSTOMER_damo B WITH(NOLOCK) ON A.RES_CODE = B.RES_CODE
		WHERE A.DEP_DATE >= CONVERT(DATE, @CHECK_DATE) AND A.DEP_DATE < @END_DATE AND A.RES_STATE < 7 AND B.RES_STATE = 0 AND A.PRO_TYPE = 2
			AND A.MASTER_CODE LIKE '[^K]%'
			AND B.NOR_TEL1 IS NOT NULL AND B.NOR_TEL2 IS NOT NULL AND B.NOR_TEL3 IS NOT NULL
	)
	, SEND_LIST AS
	(
		SELECT A.RES_CODE, MIN(A.SEQ_NO) AS [SEQ_NO], A.PHONE_NUM, (CASE WHEN MIN(A.CUS_NO) > 1 THEN MIN(A.CUS_NO) ELSE NULL END) AS [CUS_NO]
		FROM RES_LIST A
		WHERE ISNULL(A.PHONE_NUM, '') <> ''
		GROUP BY A.RES_CODE, A.PHONE_NUM
	)
	INSERT INTO #ALT_APP_RES_LIST (RES_CODE, SEQ_NO, PHONE_NUM, CUS_NO)
	SELECT A.RES_CODE, A.SEQ_NO, A.PHONE_NUM, A.CUS_NO --, B.*
	FROM SEND_LIST A
	LEFT JOIN (
		SELECT AA.RES_CODE, BB.PHONE_NUM
		FROM SEND.[dbo].[ALT_MESSAGE_MASTER] AA WITH(NOLOCK)
		INNER JOIN SEND.DBO.MZSENDLOG BB WITH(NOLOCK) ON AA.SN = BB.SN AND BB.TMPL_CD = @TMPL_CD
		WHERE AA.RES_CODE IN (SELECT DISTINCT RES_CODE FROM RES_LIST)
		GROUP BY AA.RES_CODE, BB.PHONE_NUM
	) B ON A.RES_CODE = B.RES_CODE AND A.PHONE_NUM = B.PHONE_NUM
	WHERE B.PHONE_NUM IS NULL
	ORDER BY A.RES_CODE

	-- 테스트용 임시
	--UPDATE #ALT_APP_RES_LIST SET PHONE_NUM = '01032536841'
	--INSERT INTO #ALT_T2_RES_LIST (RES_CODE, SEQ_NO, PHONE_NUM, CUS_NO) VALUES ('RP0000000000', 1, '01032536841', 15)

	-- 커서 사용변수
	DECLARE @RES_CODE VARCHAR(12), @SEQ_NO INT, @PHONE_NUM VARCHAR(15), @CUS_NO INT

	DECLARE USER_CURSOR CURSOR FOR 
		SELECT A.RES_CODE, A.SEQ_NO, A.PHONE_NUM, A.CUS_NO
		FROM #ALT_APP_RES_LIST A
	OPEN USER_CURSOR
	FETCH NEXT FROM USER_CURSOR	INTO @RES_CODE, @SEQ_NO, @PHONE_NUM, @CUS_NO

	WHILE @@FETCH_STATUS = 0
	BEGIN
		-- 알림톡 발송
		EXEC SEND.dbo.XP_ALT_MESSAGE_INSERT @SENDER_KEY, @PHONE_NUM, @TMPL_CD, @CONTS_TXT, @REQ_DTM, '[참좋은여행] 여행출발 3일전 안내', '02-2188-4000', '529', '9999999', 'Y', 'R', @RES_CODE, @CUS_NO, NULL, NULL, NULL
		--PRINT @PHONE_NUM

		FETCH NEXT FROM USER_CURSOR	INTO @RES_CODE, @SEQ_NO, @PHONE_NUM, @CUS_NO
	END

	CLOSE USER_CURSOR
	DEALLOCATE USER_CURSOR

	-- 발송건수,연락번호 리턴
	SELECT @SEND_COUNT = '[기준: ' + CONVERT(VARCHAR(10), @CHECK_DATE, 120) + '] ' + CONVERT(VARCHAR(10), ISNULL((SELECT COUNT(*) FROM #ALT_APP_RES_LIST), 0))		-- 발송건수
--		+ ISNULL((SELECT ',' + A.RES_CODE AS [text()] FROM ##ALT_APP_RES_LIST A GROUP BY A.RES_CODE FOR XML PATH('')), '')	-- 핸드폰번호

END

GO
