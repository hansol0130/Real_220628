USE [Diablo]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		이규식
-- Create date: 2010-03-24
-- Description:	행사별 여행자계약서 리스트
-- =============================================
CREATE PROCEDURE [dbo].[SP_PRO_CONTRACT_LIST]
	@PRO_CODE VARCHAR(20)
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

	DECLARE @RES_CODE CHAR(12);

	DECLARE @TEMP_TABLE TABLE (
		PRO_CODE VARCHAR(20),
		RES_CODE CHAR(12),
		CONTRACT_NO INT,
		RES_NAME VARCHAR(40),
		CUS_NAME VARCHAR(40),
		EMAIL VARCHAR(100),
		CFM_YN CHAR(1),
		CFM_DATE DATETIME,
		CREATE_YN CHAR(1),
		SND_DATE DATETIME
	);

	DECLARE USER_CURSOR2 CURSOR FOR 
		SELECT 
			A.RES_CODE
		FROM RES_MASTER_damo A
		WHERE 
			A.PRO_CODE = @PRO_CODE AND A.RES_STATE <= 7

	OPEN USER_CURSOR2
	
	FETCH NEXT FROM USER_CURSOR2 INTO @RES_CODE

	WHILE @@FETCH_STATUS = 0
	BEGIN
		INSERT INTO @TEMP_TABLE
		SELECT 
			A.PRO_CODE,
			A.RES_CODE,
			B.CONTRACT_NO,
			A.RES_NAME,
			C.CUS_NAME,
			C.EMAIL,
			B.CFM_YN,
			B.CFM_DATE,
			CASE WHEN ISNULL(B.RES_CODE, 'N') = 'N' THEN 'N' ELSE 'Y' END AS CREATE_YN,
			(SELECT TOP 1 Z.NEW_DATE FROM RES_SND_EMAIL Z 
				WHERE Z.RES_CODE = A.RES_CODE AND Z.SND_TYPE = 6 AND Z.DOC_NO = B.CONTRACT_NO) AS SND_DATE
		FROM RES_MASTER_damo A 
		LEFT JOIN (
			SELECT TOP 1 RES_CODE, CONTRACT_NO, CFM_YN, CFM_DATE 
				FROM RES_CONTRACT Z WHERE Z.RES_CODE = @RES_CODE 
				ORDER BY RES_CODE, CONTRACT_NO DESC
		) B ON B.RES_CODE = A.RES_CODE
		LEFT JOIN (
			SELECT TOP 1 RES_CODE, CUS_NAME, EMAIL FROM RES_CUSTOMER_damo Z 
				WHERE Z.RES_CODE = @RES_CODE AND Z.RES_STATE = 0 AND Z.AGE_TYPE = 0
				ORDER BY SEQ_NO
		) C ON C.RES_CODE = A.RES_CODE
		WHERE A.RES_CODE = @RES_CODE

		FETCH NEXT FROM USER_CURSOR2 INTO @RES_CODE
	END

	CLOSE USER_CURSOR2
	DEALLOCATE USER_CURSOR2
	

    -- Insert statements for procedure here
	SELECT * FROM @TEMP_TABLE
END
GO
