USE [Diablo]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*================================================================================================================
■ USP_NAME					: XP_COM_ERP_RES_MASTER_COMMON_SELECT
■ DESCRIPTION				: BTMS 예약 마스터 공통정보 검색
■ INPUT PARAMETER			: 
	@RES_CODE				: 예약코드
■ OUTPUT PARAMETER			: 
■ EXEC						: 

	EXEC XP_COM_ERP_RES_MASTER_COMMON_SELECT 'RT1604228905';

■ MEMO						: 
------------------------------------------------------------------------------------------------------------------
■ CHANGE HISTORY
------------------------------------------------------------------------------------------------------------------
   DATE				AUTHOR			DESCRIPTION           
------------------------------------------------------------------------------------------------------------------
   2016-04-22		김성호			최초생성
   2016-04-29		정지용			COM_TEAM 조인에 AND D.AGT_CODE = E.AGT_CODE 추가
   2016-08-25		정지용			COM_POSITION 조인에 AND D.AGT_CODE = F.AGT_CODE 추가
================================================================================================================*/ 
CREATE PROC [dbo].[XP_COM_ERP_RES_MASTER_COMMON_SELECT]
	@RES_CODE		VARCHAR(20)
AS 
BEGIN

	-- 예약 마스터 상세
	SELECT A.RES_CODE, A.PRO_TYPE, A.SALE_COM_CODE, B.KOR_NAME AS [SALE_COM_NAME], A.RES_NAME, A.CUS_NO, F.POS_NAME, E.TEAM_NAME, A.NOR_TEL1, A.NOR_TEL2, A.NOR_TEL3
		, A.RES_EMAIL, A.ETC, A.SENDING_REMARK, A.CUS_REQUEST, A.CUS_RESPONSE, H.KOR_NAME AS [PARENT_AGT_NAME], A.CARD_PROVE, I.STAY_ADDRESS, D.EMP_SEQ, D.EMP_ID
	FROM RES_MASTER_damo A WITH(NOLOCK)
	LEFT JOIN AGT_MASTER B WITH(NOLOCK) ON A.SALE_COM_CODE = B.AGT_CODE
	LEFT JOIN COM_EMPLOYEE_MATCHING C WITH(NOLOCK) ON A.SALE_COM_CODE = C.AGT_CODE AND A.CUS_NO = C.CUS_NO
	LEFT JOIN COM_EMPLOYEE D WITH(NOLOCK) ON C.AGT_CODE = D.AGT_CODE AND C.EMP_SEQ = D.EMP_SEQ
	LEFT JOIN COM_TEAM E WITH(NOLOCK) ON D.TEAM_SEQ = E.TEAM_SEQ AND D.AGT_CODE = E.AGT_CODE
	LEFT JOIN COM_POSITION F WITH(NOLOCK) ON D.POS_SEQ = F.POS_SEQ AND D.AGT_CODE = F.AGT_CODE
	LEFT JOIN COM_MASTER G WITH(NOLOCK) ON A.SALE_COM_CODE = G.AGT_CODE
	LEFT JOIN AGT_MASTER H WITH(NOLOCK) ON G.PARENT_AGT_CODE = H.AGT_CODE
	LEFT JOIN RES_AIR_DETAIL I WITH(NOLOCK) ON A.RES_CODE = I.RES_CODE
	WHERE A.RES_CODE = @RES_CODE

END 
/*
SELECT
	A.RES_CODE,A.PRICE_SEQ,A.SYSTEM_TYPE,A.PROVIDER,A.MEDIUM_TYPE,A.AD_CODE,A.PRO_CODE,A.PRO_NAME,A.MASTER_CODE,
	A.PRO_TYPE,A.RES_STATE,A.RES_TYPE,A.DEP_DATE,A.ARR_DATE,A.GRP_RES_CODE,A.CUS_NO,A.RES_NAME,
	--A.SOC_NUM1,damo.dbo.dec_varchar('DIABLO','dbo.RES_MASTER','SOC_NUM2', A.SEC_SOC_NUM2) AS SOC_NUM2,
	A.RES_EMAIL,A.NOR_TEL1,A.NOR_TEL2,A.NOR_TEL3,A.ETC_TEL1,A.ETC_TEL2,A.ETC_TEL3,A.RES_ADDRESS1,A.RES_ADDRESS2,A.ZIP_CODE,A.MEMBER_YN,A.CUS_REQUEST,A.CUS_RESPONSE,A.ETC,A.TAX_YN,A.INSURANCE_YN,
	A.SENDING_REMARK,A.MOV_BEFORE_CODE,A.MOV_AFTER_CODE,A.MOV_DATE,A.COMM_RATE,A.LAST_PAY_DATE,A.PNR_INFO,A.RES_PRO_TYPE,
	A.SALE_COM_CODE,A.SALE_EMP_CODE,A.SALE_TEAM_CODE,A.SALE_TEAM_NAME,A.NEW_DATE,A.NEW_CODE,A.NEW_TEAM_CODE,A.NEW_TEAM_NAME,
	A.PROFIT_EMP_CODE,A.PROFIT_TEAM_CODE,A.PROFIT_TEAM_NAME,A.EDT_DATE,A.EDT_CODE,A.COMM_AMT,
	(SELECT KOR_NAME FROM EMP_MASTER B WHERE B.EMP_CODE = A.NEW_CODE) AS NEW_NAME,
	(SELECT KOR_NAME FROM EMP_MASTER B WHERE B.EMP_CODE = A.EDT_CODE) AS EDT_NAME,
	(SELECT KOR_NAME FROM AGT_MASTER WHERE AGT_CODE = A.SALE_COM_CODE) AS SALE_COM_NAME,
	ISNULL(dbo.FN_RES_GET_SALE_PRICE(A.RES_CODE), 0) AS SALE_AMT,
	B.PNR_CODE1,	B.PNR_MODIFY_DATE,	B.PNR_REMARK,	B.AIR_PRO_TYPE, B.STAY_ADDRESS,
	D.SEQ_NO AS SCH_SEQ_NO, D.SCH_DATE,	D.CONTENTS , D.ALT_TIME ,
	A.IPIN_DUP_INFO , A.VIEW_YN ,
	A.GENDER , A.BIRTH_DATE 
FROM RES_MASTER_damo A WITH(NOLOCK)
INNER JOIN RES_AIR_DETAIL B WITH(NOLOCK) ON B.RES_CODE = A.RES_CODE
LEFT JOIN PRI_SCHEDULE D WITH(NOLOCK) ON A.RES_CODE = D.RES_CODE 
	AND SEQ_NO  = ( SELECT TOP 1 SEQ_NO FROM  PRI_SCHEDULE WITH(NOLOCK) WHERE RES_CODE = D.RES_CODE ORDER BY SEQ_NO DESC )
WHERE A.RES_CODE = @RES_CODE
*/
GO
