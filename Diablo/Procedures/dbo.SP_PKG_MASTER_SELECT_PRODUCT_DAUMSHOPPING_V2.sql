USE [Diablo]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- ==========================================================================================
-- DESCRIPTION:	< DaumShoppingProductMakeText.exe >
--		 shopping.daum.net 여행 카테고리 상품 전송   2015/07 새로운 포맷 DAUM 상품EP 가이드 V1.0 참고 
-- CREATE DATE: <2015-07-30>
-- AUTHOR:		<박형만>
-- exec SP_PKG_MASTER_SELECT_PRODUCT_DAUMSHOPPING_V2 
-- 2015-07-30 박형만 최초생성
-- 2015-10-15 박형만 컨텐츠 정보 수정시 , 이미지 수정 추가 
-- ==========================================================================================
CREATE  PROC [dbo].[SP_PKG_MASTER_SELECT_PRODUCT_DAUMSHOPPING_V2]
	--@PROVIDER INT 
AS 
SET NOCOUNT ON 
 
 
--고정노출 상품 
DECLARE @TMP_PRODUCT_LIST  TABLE 
(	
	MASTER_CODE VARCHAR(20),
	CITY_CODE VARCHAR(10),
	RCNT INT ,
	IS_FIX TINYINT DEFAULT 0
) 
-- 마스터별 최근 한달 예약 판매량
INSERT INTO @TMP_PRODUCT_LIST (MASTER_CODE , CITY_CODE, RCNT , IS_FIX )
SELECT MASTER_CODE , DBO.XN_PRO_MASTER_GET_MAINCITY_CODE(MASTER_CODE),  COUNT(RC.RES_CODE) AS RCNT , 0 
FROM RES_MASTER_DAMO RM WITH(NOLOCK)
	INNER JOIN RES_CUSTOMER_DAMO RC WITH(NOLOCK)
		ON RM.RES_CODE = RC.RES_CODE 
		AND RM.RES_STATE <= 7 
		AND RC.RES_STATE IN (0, 3, 4)
WHERE RM.NEW_DATE BETWEEN CONVERT(DATETIME,DATEADD(m,-1,GETDATE() ) )
	AND GETDATE()
	AND RM.PRO_TYPE IN ( 1 ) 
GROUP BY MASTER_CODE 
ORDER BY COUNT(RC.RES_CODE) DESC 

--상위5 개의 평균판매량
DECLARE @TOP_AVG_RCNT INT 
SET @TOP_AVG_RCNT = 
(	SELECT AVG(RCNT) FROM @TMP_PRODUCT_LIST 
	WHERE MASTER_CODE IN (SELECT TOP 5 MASTER_CODE FROM @TMP_PRODUCT_LIST ORDER BY RCNT DESC))
--SELECT @TOP_AVG_RCNT
IF @TOP_AVG_RCNT IS NULL 
BEGIN
	SET @TOP_AVG_RCNT = 500 -- 기본 마스터별 판매량 
END 
--2014.02-25 이세인씨 요청 고정적으로 베스트에 나오길 원하는 상품 

DECLARE @FIX_PRODUCTS VARCHAR(4000)
SET @FIX_PRODUCTS = '
JPP018,
JPP091,
JPP6667,
JPP6666,
JPP6699,
JPP677,
JPP488,

CPP861,
CPP3633,

APP2035,
APP5001,
APP059,
APP695,

PPP257,

EPP600,
EPP602,
UPP3281'
INSERT INTO @TMP_PRODUCT_LIST 
SELECT data ,  DBO.XN_PRO_MASTER_GET_MAINCITY_CODE(data) ,
ABS(CHECKSUM(NewId())) % 100 + @TOP_AVG_RCNT , -- 상위 판매량 평균 + 1~200 랜덤 판매량 부여
1   
FROM DBO.FN_SPLIT ( REPLACE(@FIX_PRODUCTS, CHAR(13)+CHAR(10),'') , ',') 
WHERE DATA NOT IN ( SELECT MASTER_CODE FROM @TMP_PRODUCT_LIST)
--SELECT ABS(CHECKSUM(NewId())) % 100
--데이터 검증 
--SELECT TOP 10000 * FROM @TMP_PRODUCT_LIST
--ORDER BY RCNT DESC 
;
--상품정보 리스트 
WITH PRODUCT_LIST  AS 
(
	SELECT 
		UPPER(PM.MASTER_CODE)  AS MASTER_CODE,
		PM.MASTER_NAME  ,
		--'http://daum.verygoodtour.com/Product/Package/PackageMaster.aspx?masterCode='+UPPER(PM.MASTER_CODE) AS PGURL ,
		'http://www.verygoodtour.com/Affiliate/DaumShop/PackageMaster?masterCode='+UPPER(PM.MASTER_CODE) AS PGURL ,
		--이미지링크
		'http://contents.verygoodtour.com'+ '/CONTENT/' +  
		IFM.REGION_CODE +'/'+
		IFM.NATION_CODE +'/'+
		IFM.STATE_CODE +'/'+
		IFM.CITY_CODE +'/'+
		+ CASE WHEN IFM.FILE_TYPE = 1  THEN 'image'
			WHEN IFM.FILE_TYPE = 2  THEN 'movie'
			WHEN IFM.FILE_TYPE = 3 THEN 'document' 
		ELSE 'image' END  + '/'  AS CONTENTS_PATH ,
		--IFM.[FILE_NAME] + '.' + IFM.EXTENSION_NAME AS [FILE_NAME] , 
		--CASE WHEN ISNULL(IFM.[FILE_NAME_S],'') ='' THEN IFM.[FILE_NAME] + '.' + IFM.EXTENSION_NAME  ELSE IFM.[FILE_NAME_S] END AS SMALL_IMG,
		--CASE WHEN ISNULL(IFM.[FILE_NAME_M],'') ='' THEN IFM.[FILE_NAME] + '.' + IFM.EXTENSION_NAME  ELSE IFM.[FILE_NAME_M] END AS MIDDLE_IMG,
		CASE WHEN ISNULL(IFM.[FILE_NAME_L],'') ='' THEN IFM.[FILE_NAME] + '.' + IFM.EXTENSION_NAME  ELSE IFM.[FILE_NAME_L] END AS BIG_IMG,

		-------카테고리----------
		CASE WHEN PM.SIGN_CODE = 'K' THEN 'KOR' ELSE 'FOR' END AS SIGN_CATE ,
		CASE WHEN PM.SIGN_CODE = 'K' THEN 'DO1' ELSE 'OU1' END AS BEST_CATE ,
		CASE WHEN PM.SIGN_CODE = 'K' THEN '국내여행' ELSE '해외여행' END AS SIGN_CATENAME ,
		CASE WHEN PM.ATT_CODE IN ('P') THEN 'P' --패키지
			 WHEN PM.ATT_CODE IN ('F','E','J','K','L','O','S','T','V','X','Y','D','A') THEN 'F' --자유여행
			 WHEN PM.ATT_CODE IN ('H','Z') THEN 'H' --호텔팩
			 WHEN PM.ATT_CODE IN ('W') THEN 'W' --허니문
			 WHEN PM.ATT_CODE IN ('R') THEN 'R' --실시간항공
			 WHEN PM.ATT_CODE IN ('G') THEN 'G'--골프
			 WHEN PM.ATT_CODE IN ('I','B') THEN 'I'--에어텔(항공+호텔)
			 WHEN PM.ATT_CODE IN ('T') THEN 'T'--티켓
			 WHEN PM.ATT_CODE IN ('C') THEN 'C'--크루즈
		ELSE 'P' END AS ATT_CATE , 
		CASE WHEN PM.ATT_CODE IN ('P') THEN '패키지' --패키지
			 WHEN PM.ATT_CODE IN ('F','E','J','K','L','O','S','T','V','X','Y','D','A') THEN '자유여행' --자유여행
			 WHEN PM.ATT_CODE IN ('H','Z') THEN '호텔팩' --호텔팩
			 WHEN PM.ATT_CODE IN ('W') THEN '허니문' --허니문
			 WHEN PM.ATT_CODE IN ('R') THEN '실시간항공' --실시간항공
			 WHEN PM.ATT_CODE IN ('G') THEN '골프'--골프
			 WHEN PM.ATT_CODE IN ('I','B') THEN '에어텔'--에어텔(항공+호텔)
			 WHEN PM.ATT_CODE IN ('T') THEN '티켓'--티켓
			 WHEN PM.ATT_CODE IN ('C') THEN '크루즈'--크루즈
		ELSE '패키지' END AS ATT_NAME, 

		PM.ATT_CODE , 
		PM.REGION_ORDER  , 

		A.CITY_CODE ,
		PC.KOR_NAME AS CITY_NAME ,
		PN.NATION_CODE,
		PN.KOR_NAME AS NATION_NAME,
		PR.REGION_CODE , 
		PR.KOR_NAME AS REGION_NAME,
		PM.SIGN_CODE,

		CONVERT(VARCHAR(10), PM.NEXT_DATE , 111) AS ST_DATE ,
		CONVERT(VARCHAR(10), DATEADD(DD,ISNULL(PM.TOUR_DAY,1) ,PM.LAST_DATE) ,111) AS ED_DATE, --도착일까지는 전시
		PM.TOUR_JOURNEY AS AREA ,
		KEYWORD AS PLACE , 
		ROW_NUMBER() OVER ( ORDER BY A.RCNT DESC , PM.REGION_ORDER DESC )   AS WEIGHT ,  -- 가중치 0~
		
		A.RCNT AS SALES  ,  --판매량
		
		'' AS COUPON , -- 쿠폰 
		'' AS PCARD , -- 무이자 할부 

		CASE WHEN ISNULL(PM.LOW_POINT_RATE,0) = 0 AND ISNULL(PM.HIGH_POINT_RATE,0) = 0 THEN '' 
		ELSE CONVERT(VARCHAR,ISNULL(CONVERT(decimal(2,1),PM.LOW_POINT_RATE),0)) +'%' 
			+ '~'
			+ CONVERT(VARCHAR,ISNULL(CONVERT(decimal(2,1),PM.HIGH_POINT_RATE),0)) +'%' END AS POINT ,
		 
		'' AS REVIEW , 
		'' AS EVENT , 

		CASE WHEN A.IS_FIX = 1 THEN 'Y' ELSE 'N' END AS FIXED_YN ,

		-----------가격정보----------
		'최저가' AS SEAT,
		PM.LOW_PRICE  AS PRICE ,
		--PM.HIGH_PRICE  AS DP_MAX_PRICE ,
		'' AS DISCOUNT , 
		----------------------------

		( SELECT COUNT(*) FROM PRO_COMMENT WITH(NOLOCK) WHERE MASTER_CODE  = A.MASTER_CODE ) AS REVCT  ,
		(SELECT CONVERT(DECIMAL(5,1), AVG( (POINT1 + POINT2 + POINT3 + POINT4 + POINT5) / 5.0)) FROM PRO_COMMENT WITH(NOLOCK) WHERE MASTER_CODE  = A.MASTER_CODE) AS RATING ,
		--컨텐츠 파일이 최근 3일 내에 수정되었으면 수정으로 
		CASE WHEN (IFM.EDT_DATE IS NOT NULL AND IFM.EDT_DATE > DATEADD(DD,-3,GETDATE()))
				OR (IFM.NEW_DATE IS NOT NULL AND IFM.NEW_DATE > DATEADD(DD,-3,GETDATE()))  THEN 'Y' ELSE 'N' END AS UPIMG

	FROM @TMP_PRODUCT_LIST AS A 
		INNER JOIN PKG_MASTER AS PM WITH(NOLOCK)
			ON A.MASTER_CODE  = PM.MASTER_CODE 
		
		--G마켓,다음 상품은 마스터 이미지정보 반드시 있어야함 - 사전공지 AND ERP 시스템 체크 
		INNER JOIN PKG_FILE_MANAGER AS PFM WITH(NOLOCK )
			ON PM.MASTER_CODE = PFM.MASTER_CODE
			AND PFM.FILE_CODE = ( SELECT TOP 1 S1.FILE_CODE FROM PKG_FILE_MANAGER AS S1 WITH(NOLOCK)
							INNER JOIN INF_FILE_MASTER AS S2 WITH(NOLOCK)
								ON S1.FILE_CODE = S2.FILE_CODE 
							WHERE S1.MASTER_CODE = PFM.MASTER_CODE 
							AND S2.SHOW_YN = 'Y'
							ORDER BY SHOW_ORDER ) 
		INNER JOIN INF_FILE_MASTER AS IFM WITH(NOLOCK)
			ON PFM.FILE_CODE = IFM.FILE_CODE
		
		--INNER JOIN PKG_MASTER_AFFILIATE AS PMA WITH(NOLOCK)
		--	ON PM.MASTER_CODE = PMA.MASTER_CODE 
		--	--AND PMA.AFF_TYPE = 1 -- G마켓 
		--	AND PMA.PROVIDER = @PROVIDER -- G마켓 

		INNER JOIN PUB_CITY AS PC 
			ON A.CITY_CODE = PC.CITY_CODE 
		INNER JOIN PUB_NATION AS PN 
			ON PC.NATION_CODE = PN.NATION_CODE 
		INNER JOIN PUB_REGION AS PR
			ON PN.REGION_CODE = PR.REGION_CODE 
	

	WHERE PM.NEXT_DATE > GETDATE()
	AND PM.LAST_DATE > GETDATE()
	AND PM.SHOW_YN  = 'Y' 
)
 
  
SELECT
A.MASTER_CODE AS MAPID,
A.PRICE,
DBO.XN_PRO_MASTER_DAUMSHOP_GET_PRO_NAME( A.MASTER_NAME , ATT_NAME , CITY_NAME , NATION_NAME , REGION_NAME ) AS PNAME , 
A.PGURL, CONTENTS_PATH  + BIG_IMG AS IGURL ,
A.UPIMG , 
SIGN_CATENAME AS CATE1 , 
SIGN_CATE AS CAID1 , 
ATT_NAME AS CATE2 , 
SIGN_CATE  + '00'+ATT_CATE AS CAID2 , 
REGION_NAME AS CATE3 , 
SIGN_CATE  + '00'+ATT_CATE + REGION_CODE AS CAID3 , 
CASE WHEN REGION_NAME = NATION_NAME THEN '' ELSE NATION_NAME END AS CATE4 , 
CASE WHEN REGION_NAME = NATION_NAME THEN '' ELSE SIGN_CATE  + '00'+ATT_CATE + REGION_CODE + NATION_CODE END  AS CAID4 ,
POINT ,
'0' AS DELIV , 
WEIGHT,
ISNULL(  CONVERT(VARCHAR(10), RATING) +'/5' , '') AS RATING  ,
REVCT
FROM PRODUCT_LIST AS A
ORDER BY A.WEIGHT, A.REGION_ORDER ASC 

GO
