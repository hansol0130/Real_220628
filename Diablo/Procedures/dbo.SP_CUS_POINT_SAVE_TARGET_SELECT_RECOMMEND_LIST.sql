USE [Diablo]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==========================================================================================
-- DESCRIPTION:	<포인트 추천인 적립 대상자 조회 PointSaveSendMail.exe >
--		도착 7일째 추천인이 있는 정상 출발 예약의 포인트 조회 
-- CREATE DATE: <2010-05-13>
-- AUTHOR:		<박형만>
-- EXEC [SP_CUS_POINT_SAVE_TARGET_SELECT_RECOMMEND_LIST]  '2018-09-19'
-- EDIT DATE: <2010-05-13> 

-- 2018-10-19 최초 생성 

-- ==========================================================================================
CREATE PROC [dbo].[SP_CUS_POINT_SAVE_TARGET_SELECT_RECOMMEND_LIST]
	@EXE_DATE VARCHAR(10)
AS 
SET NOCOUNT ON 
BEGIN
	--포인트 추천인 적립 대상자 조회 old  
	--DECLARE @EXE_DATE VARCHAR(10)
	--SET @EXE_DATE = '2016-09-09'
	--DECLARE @EXE_DATE VARCHAR(10)
	--SET @EXE_DATE = '2018-12-28'
	DECLARE @START_DATE DATETIME 
	SET @START_DATE = DATEADD(DD,-7,CONVERT(DATETIME, @EXE_DATE))  -- 출발일시
	DECLARE @END_DATE DATETIME 
	SET @END_DATE = DATEADD(S,-1,DATEADD(DD,1,@START_DATE))  --도착일시 

	--SELECT @START_DATE , @END_DATE 
	--포인트 적립 대상자 조회 2016-09-08  , 
	SELECT RR.REC_CUS_NO AS CUS_NO,/*RC.POINT_PRICE,*/  
	ISNULL(CC.CUS_ID,CMS.CUS_ID) AS CUS_ID ,

	--ISNULL((SELECT TOP 1 ADT_PRICE FROM PKG_DETAIL_PRICE WHERE PRO_CODE = PD.PRO_CODE ORDER BY ADT_PRICE), 0) AS [PRO_PRICE]
	ISNULL(dbo.XN_PRO_DETAIL_SALE_PRICE_CUTTING(RM.PRO_CODE,RM.PRICE_SEQ) , 0) AS [TOTAL_PRICE], --추가  

	--CONVERT(INT,DBO.FN_RES_GET_TOTAL_PRICE_ONE(RC.RES_CODE,RC.SEQ_NO) * 0.01) AS POINT_PRICE ,
	RM.RES_CODE,RM.PRO_NAME,
	RM.RES_NAME,
	ISNULL(CMS.CUS_NAME,CC.CUS_NAME) AS CUS_NAME,
	PD.ARR_DATE AS ARR_DATE, ISNULL(CP.POINT_PRICE,0) AS SAVE_POINT , --기적립 포인트
	--CC.SOC_NUM1 , damo.dbo.dec_varchar('DIABLO', 'dbo.CUS_CUSTOMER', 'SOC_NUM2', CC.sec_SOC_NUM2) AS SOC_NUM2,
	ISNULL(CMS.BIRTH_DATE,CC.BIRTH_DATE) AS BIRTH_DATE,
	ISNULL(CMS.GENDER,CC.GENDER) AS GENDER,
	
	--추천인정보 
	ISNULL(CC.BIRTH_DATE,CMS.BIRTH_DATE) AS BIRTH_DATE,
	ISNULL(CC.NOR_TEL1,CMS.NOR_TEL1) AS NOR_TEL1,
	ISNULL(CC.NOR_TEL2,CMS.NOR_TEL2) AS NOR_TEL2,
	ISNULL(CC.NOR_TEL3,CMS.NOR_TEL3) AS NOR_TEL3

	FROM PKG_DETAIL AS PD WITH(NOLOCK)
		INNER JOIN RES_MASTER_damo AS RM WITH(NOLOCK) 
			ON PD.PRO_CODE = RM.PRO_CODE 
		INNER JOIN RES_RECOMMEND AS RR WITH(NOLOCK) 
			ON RM.RES_CODE = RR.RES_CODE 
			
		LEFT JOIN CUS_MEMBER_SLEEP AS CMS WITH(NOLOCK)
			ON RR.REC_CUS_NO = CMS.CUS_NO 

		LEFT JOIN CUS_MEMBER AS CC WITH(NOLOCK)
			ON RR.REC_CUS_NO = CC.CUS_NO 
			
		LEFT JOIN CUS_POINT AS CP WITH(NOLOCK)
			ON CP.RES_CODE = RR.RES_CODE 
			AND CP.CUS_NO = RR.REC_CUS_NO 
			AND POINT_TYPE = 1 --적립만 

		--LEFT JOIN CUS_POINT AS CP2 WITH(NOLOCK)
		--	ON CC.CUS_NO = CP2.CUS_NO 
		--	AND CP2.NEW_dATE > '2018-01-13'  -- 특정일 이후 
		--	AND CP2.POINT_TYPE = 1 
		--	AND CP2.ACC_USE_TYPE = 2 --  관리자 적립 있는것 

	--WHERE ISNULL(PTS.ARR_ARR_DATE,PD.ARR_DATE)  = DATEADD(DD,-7,CONVERT(DATETIME, @EXE_DATE)) --도착후7일
	--WHERE PD.ARR_DATE = DATEADD(DD,-7,CONVERT(DATETIME, @EXE_DATE)) --도착후7일
	WHERE PD.ARR_DATE BETWEEN @START_DATE AND @END_DATE  --도착후 7일 
	AND PD.DEP_DATE > CONVERT(DATETIME,DATEADD(M,-3,CONVERT(DATETIME,@EXE_DATE)) ) --  실행일 한달전 출발 만
	AND RM.ARR_DATE BETWEEN DATEADD(D,-1,@START_DATE) AND DATEADD(D,1,@END_DATE) --[20160908추가] 예약테이블의 도착일은 +- 1일 오차 있음 
	AND RM.DEP_DATE > CONVERT(DATETIME,DATEADD(M,-3,CONVERT(DATETIME,@EXE_DATE)) ) -- [20160908추가] 실행일 한달전 출발 만
	--AND RC.POINT_PRICE > 0
	AND (CC.POINT_CONSENT ='Y' OR CMS.POINT_CONSENT ='Y') --포인트 동의
	--AND CC.CUS_STATE = 'Y' --정회원 상태Y 인것
	--AND (RC.DC_PRICE IS NULL OR RC.DC_PRICE = 0)  --DC 적용된 회원은 적립 안함
	AND RM.RES_STATE IN (3,4,5,6) -- 예약상태 결제중,결제완료,출발완료,해피콜 - 2010.07.12 결제중도 적립
	--AND RC.RES_STATE IN (0) -- 출발고객상태 예약인것만
	--AND (CC.POINT_CONSENT_DATE <  CONVERT(DATETIME,DATEADD(DD,7,CONVERT(DATETIME,  PD.ARR_DATE )) ) 
	--	OR CMS.POINT_CONSENT_DATE <  CONVERT(DATETIME,DATEADD(DD,7,CONVERT(DATETIME,  PD.ARR_DATE )) ) )

	

END 

GO
