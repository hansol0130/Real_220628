USE [Diablo]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*================================================================================================================
■ USP_NAME					: XP_COM_BIZTRIP_MASTER_SELECT
■ DESCRIPTION				: 출장예약마스터 조회 
■ INPUT PARAMETER			: 
	
■ OUTPUT PARAMETER			: 
■ EXEC						: 

	exec dbo.XP_COM_BIZTRIP_MASTER_SELECT '93971', 'BT1610040259', '101'
	
■ MEMO						: 
------------------------------------------------------------------------------------------------------------------
■ CHANGE HISTORY                   
------------------------------------------------------------------------------------------------------------------
	DATE			AUTHOR		DESCRIPTION           
------------------------------------------------------------------------------------------------------------------
	2016-03-10		박형만		최초생성   ---> 제가 최초 생성 아닌데,, 완전 다름 누가 하신건가요?
	2016-03-25		김성호		출장예약상세에 맞게 수정
	2016-03-28		이유라		승인자이름,요청자이름,예약번호 등 추가
	2016-04-04		이유라		판매금액 FN_RES_GET_SALE_PRICE -> FN_RES_GET_TOTAL_PRICE, 도착편명조인 수정
								문자,이메일 테이블 수정 RES_SND_ -> COM_RECEIVE_

	2016-04-28		박형만		항공은 (항공사)여정-여정-여정... 으로 수정 
	2016-05-09		김성호		출장상태 예약 상태 기준 실시간 상태값 검색으로 변경
	2016-05-18		박형만		출장예약에 정상 출발자들의 EMP_SEQ 구함 EX) 122,100,133
	2016-05-26		백경훈		팀이름이 널값일때 공란 처리
	2016-06-01		박형만		출발자 EMP_SEQ 에서 출발 상태 제외 
	2016-06-22		강태영		출발자 이메일 SELECT 추가

	2016-07-08		박형만		항공세그잘못된것 수정, 모바일관련 항공사명추가 
	2016-08-04		이유라		HP_NUMBER, MANAGE_CODE 추가
	2016-08-17		박형만		항공예약 항공사명 대신 , 비행타입(왕복,편도)명 조회  , ROUTING_TYPE 함수로 변경 
	2016-08-25		박형만		디자인 변경에 따른 항공정보 추가 
	2016-08-29		박형만		항공도착일 없으면(편도) 항공상세의 출발편도착일 표시 , 출발일 빠른순으로 정렬 
	2016-09-27		이유라		출장자페이지이고 예약자가 아닐경우 출발자에 포함되는 예약건만 노출
	2016-10-10		이유라		출장자리스트 - 상태 "예약"인것만 노출 
================================================================================================================*/ 
CREATE  PROC [dbo].[XP_COM_BIZTRIP_MASTER_SELECT]
(
	@AGT_CODE	VARCHAR(10),
	@BT_CODE	VARCHAR(20),
	@EMP_CODE   VARCHAR(5) = null
)
AS 
BEGIN
	-- 기본정보
	SELECT 	CBM.AGT_CODE, 
			CBM.BT_CODE,
			ISNULL((
				SELECT (CASE WHEN MIN(RM.RES_STATE) < 7 THEN 0 WHEN MIN(RM.RES_STATE) = 7 THEN 7 ELSE 9 END)
				FROM COM_BIZTRIP_DETAIL CBD WITH(NOLOCK)
				INNER JOIN RES_MASTER_damo RM WITH(NOLOCK) ON CBD.RES_CODE = RM.RES_CODE
				WHERE CBD.AGT_CODE = CBM.AGT_CODE AND CBD.BT_CODE = CBM.BT_CODE
			), 9) AS [BT_STATE],
			--CBM.BT_STATE,
			CBM.APPROVAL_STATE,
			CBM.BT_START_DATE,
			CBM.BT_END_DATE,
			CBM.REQUEST_DATE,
			CBM.REQUEST_REMARK,
			CBM.CONFIRM_REMARK,
			CBM.CONFIRM_DATE,
			CBM.CONFIRM_EMP_SEQ,
			CE2.KOR_NAME AS [CONFIRM_EMP_NAME],
			CT2.TEAM_NAME AS [CONFIRM_TEAM_NAME],
			CP2.POS_NAME AS [CONFIRM_POS_NAME], 
			CBM.NEW_DATE,
			CBM.NEW_SEQ,
			CE1.KOR_NAME AS [NEW_EMP_NAME],
			CT1.TEAM_NAME as [NEW_TEAM_NAME], 
			CP1.POS_NAME as [NEW_POS_NAME] ,
			CE1.EMAIL AS [NEW_EMP_EMAIL],
			CE1.HP_NUMBER AS [NEW_EMP_HP_NUMBER],
			STUFF((
				SELECT (',' + CONVERT(VARCHAR,ISNULL(CC.EMP_SEQ,'')) ) AS [text()]
				FROM COM_BIZTRIP_DETAIL AA
					INNER JOIN RES_CUSTOMER_damo BB
						ON AA.RES_CODE = BB.RES_CODE 
						AND CBM.BT_CODE = AA.BT_CODE 
						AND CBM.AGT_CODE = AA.AGT_CODE
					INNER JOIN COM_EMPLOYEE_MATCHING CC
						ON CBM.AGT_CODE = CC.AGT_CODE 
						AND BB.CUS_NO = CC.CUS_NO 
				WHERE CBM.BT_CODE = AA.BT_CODE 
				--AND BB.RES_STATE = 0  -- 취소된 예약의 출발자도 보여야 하기에 , 해당 조건 삭제 
				GROUP BY CC.EMP_SEQ  
				FOR XML PATH('')), 1, 1, '') AS CUS_EMP_SEQ,
			CMC.MANAGE_CODE
	FROM COM_BIZTRIP_MASTER CBM WITH(NOLOCK)
	LEFT JOIN COM_EMPLOYEE CE1 WITH(NOLOCK) ON CBM.AGT_CODE = CE1.AGT_CODE and CBM.NEW_SEQ = CE1.EMP_SEQ
	LEFT JOIN COM_TEAM CT1 WITH(NOLOCK) ON CE1.AGT_CODE = CT1.AGT_CODE AND CE1.TEAM_SEQ = CT1.TEAM_SEQ
	LEFT JOIN COM_POSITION CP1 WITH(NOLOCK) ON CBM.AGT_CODE = CP1.AGT_CODE and CE1.POS_SEQ = CP1.POS_SEQ
	LEFT JOIN COM_EMPLOYEE CE2 WITH(NOLOCK) ON CBM.AGT_CODE = CE2.AGT_CODE AND CBM.CONFIRM_EMP_SEQ = CE2.EMP_SEQ
	LEFT JOIN COM_TEAM CT2 WITH(NOLOCK) ON CE2.AGT_CODE = CT2.AGT_CODE and CE2.TEAM_SEQ = CT2.TEAM_SEQ
	LEFT JOIN COM_POSITION CP2 WITH(NOLOCK) ON CBM.AGT_CODE = CP2.AGT_CODE AND CE2.POS_SEQ = CP2.POS_SEQ
	LEFT JOIN (
		SELECT TOP 1 A.AGT_CODE, A.EMP_CODE AS [MANAGE_CODE], B.KOR_NAME AS [MANAGE_NAME]
		FROM COM_MANAGER A WITH(NOLOCK)
		INNER JOIN EMP_MASTER B WITH(NOLOCK) ON A.EMP_CODE = B.EMP_CODE
		WHERE A.AGT_CODE = @AGT_CODE AND A.MANAGER_TYPE = 0
	) CMC ON CBM.AGT_CODE = CMC.AGT_CODE
	WHERE CBM.AGT_CODE = @AGT_CODE and CBM.BT_CODE = @BT_CODE;
 
	-- 예약정보

	--예약자 본인이거나 관리자페이지일 경우 출장-모든 예약건 노출
	IF( @EMP_CODE = (SELECT CBM.NEW_SEQ FROM COM_BIZTRIP_MASTER CBM WHERE CBM.AGT_CODE = @AGT_CODE and CBM.BT_CODE = @BT_CODE) OR @EMP_CODE IS NULL)
	BEGIN 
		SELECT CBM.AGT_CODE, CBM.BT_CODE, RMD.RES_CODE, RMD.RES_STATE, RMD.NEW_DATE, 
		CASE WHEN RMD.PRO_TYPE = 2 THEN 
		--ISNULL( (SELECT '(' +KOR_NAME +')' FROM PUB_AIRLINE WHERE AIRLINE_CODE = RS1.AIRLINE_CODE ) , '') + 
		(CASE dbo.FN_RES_AIR_GET_RTG_TYPE(RMD.RES_CODE) WHEN 1 THEN '(편도)' WHEN 2 THEN '(다구간)' ELSE '(왕복)' END ) +
		dbo.FN_RES_AIR_GET_PRO_NAME(RMD.RES_CODE)   --항공일때 항공사 + 여정표시  
			ELSE RMD.PRO_NAME END AS PRO_NAME , 
		RMD.DEP_DATE, (CASE WHEN RMD.ARR_DATE IS NULL THEN CONVERT(DATETIME,CONVERT(VARCHAR(10), RAD.DEP_ARR_DATE) + ' ' + RAD.DEP_ARR_TIME ) ELSE RMD.ARR_DATE END) AS ARR_DATE --RMD.ARR_DATE
			, RS1.AIRLINE_CODE AS [FIRST_AIRLINE_CODE], RS1.FLIGHT AS [FIRST_FLIGHT], RS2.AIRLINE_CODE AS [LAST_AIRLINE_CODE], RS2.FLIGHT AS [LAST_FLIGHT], dbo.FN_RES_AIR_GET_RTG_TYPE(RMD.RES_CODE) AS [ROUTING_TYPE]
			, (SELECT KOR_NAME FROM PUB_AIRLINE WHERE AIRLINE_CODE = RS1.AIRLINE_CODE ) AS FIRST_AIRLINE_NAME 
			, (SELECT KOR_NAME FROM PUB_AIRLINE WHERE AIRLINE_CODE = RS2.AIRLINE_CODE ) AS LAST_AIRLINE_NAME 
			, CASE WHEN RMD.PRO_TYPE = 2 THEN dbo.FN_RES_AIR_GET_PRO_NAME(RMD.RES_CODE) ELSE '' END  AS ROUTING_TEXT 
			, CASE WHEN RMD.PRO_TYPE = 2 THEN ISNULL((SELECT MAX(SEG_CNT) FROM (SELECT COUNT(*) SEG_CNT FROM RES_SEGMENT WHERE RES_CODE = RMD.RES_CODE GROUP BY DIRECTION  ) T ),0) - 1  END AS NUMBER_OF_STOP 
			, RAD.FARE_SEAT_TYPE
			, (CASE
				WHEN RAD.FARE_SEAT_TYPE = 1 THEN '일반석'
				WHEN RAD.FARE_SEAT_TYPE = 2 THEN '비즈니스'
				WHEN RAD.FARE_SEAT_TYPE = 3 THEN '일등석' END) AS [AIR_CLASS]
			, (SELECT (MAX(RHRD.ROOM_NAME) + ' ' + CONVERT(VARCHAR(10), COUNT(*)) + '개') FROM RES_HTL_ROOM_DETAIL RHRD WHERE RHRD.RES_CODE = RMD.RES_CODE GROUP BY RHRD.RES_CODE) AS [ROOM_NAME]
			, DATEDIFF(DAY, RMD.DEP_DATE, (CASE WHEN RMD.ARR_DATE IS NULL THEN CONVERT(DATETIME,CONVERT(VARCHAR(10), RAD.DEP_ARR_DATE) + ' ' + RAD.DEP_ARR_TIME ) ELSE RMD.ARR_DATE END)) AS [PRO_DAY], RMD.LAST_PAY_DATE
			, DATEDIFF(DAY, GETDATE(), RMD.LAST_PAY_DATE) AS [LIMIT_DAY]
			, (CASE
				WHEN RMD.PRO_TYPE = 2 THEN '항공'
				WHEN RMD.PRO_TYPE = 3 THEN '호텔'
				WHEN RMD.PRO_TYPE = 1 AND CBD.PRO_DETAIL_TYPE = 4 THEN '렌트카'
				WHEN RMD.PRO_TYPE = 1 AND CBD.PRO_DETAIL_TYPE = 5 THEN '비자'
				WHEN RMD.PRO_TYPE = 1 AND CBD.PRO_DETAIL_TYPE = 9 THEN '기타' END) AS [PRO_TYPE_NAME]
			, (SELECT COUNT(*) FROM COM_RECEIVE_SMS RSS WHERE RMD.RES_CODE = RSS.RES_CODE ) AS SMS_COUNT
			, (SELECT COUNT(*) FROM COM_RECEIVE_EMAIL RSE WHERE RMD.RES_CODE = RSE.RES_CODE ) AS EMAIL_COUNT
			, SUBSTRING((
				SELECT (',' + RCD.CUS_NAME + ' ' + (CASE WHEN CE.EMP_SEQ IS NULL THEN ('(외부인)') ELSE (ISNULL(CP.POS_NAME,'') + '(' + ISNULL(CT.TEAM_NAME,'') + ')') END)) AS [text()]
				FROM RES_MASTER_damo RMD2
				INNER JOIN RES_CUSTOMER_damo RCD WITH(NOLOCK) ON RMD2.RES_CODE = RCD.RES_CODE AND RCD.RES_STATE = 0
				LEFT JOIN COM_EMPLOYEE_MATCHING CEM WITH(NOLOCK) ON CEM.AGT_CODE = @AGT_CODE AND RCD.CUS_NO = CEM.CUS_NO
				LEFT JOIN COM_EMPLOYEE CE WITH(NOLOCK) ON CEM.AGT_CODE = CE.AGT_CODE and CEM.EMP_SEQ = CE.EMP_SEQ
				LEFT JOIN COM_TEAM CT WITH(NOLOCK) ON CE.AGT_CODE = CT.AGT_CODE AND CE.TEAM_SEQ = CT.TEAM_SEQ
				LEFT JOIN COM_POSITION CP WITH(NOLOCK) ON CE.AGT_CODE = CP.AGT_CODE and CE.POS_SEQ = CP.POS_SEQ
				WHERE RMD2.res_code = CBD.RES_CODE --AND RMD2.RES_STATE <= 7 AND RCD.RES_STATE = 0
				FOR XML PATH('')
			), 2, 10000) AS [CUS_LIST]
			, RCC.TOTAL_RES_COUNT, RCC.ADT_COUNT, RCC.CHD_COUNT, RCC.INT_COUNT
			, dbo.FN_RES_GET_TOTAL_PRICE(RMD.RES_CODE) AS TOTAL_SALE_PRICE
		FROM COM_BIZTRIP_MASTER CBM WITH(NOLOCK)
		INNER JOIN COM_BIZTRIP_DETAIL CBD WITH(NOLOCK) ON CBM.AGT_CODE = CBD.AGT_CODE and CBM.BT_CODE = CBD.BT_CODE
		INNER JOIN RES_MASTER_damo RMD WITH(NOLOCK) ON CBD.RES_CODE = RMD.RES_CODE
		LEFT JOIN RES_AIR_DETAIL RAD WITH(NOLOCK) ON RMD.RES_CODE = RAD.RES_CODE
		LEFT JOIN RES_SEGMENT RS1 WITH(NOLOCK) ON RAD.RES_CODE = RS1.RES_CODE AND RS1.SEQ_NO = 1
		LEFT JOIN RES_SEGMENT RS2 WITH(NOLOCK) ON RAD.RES_CODE = RS2.RES_CODE AND RS2.SEQ_NO = (SELECT MAX(SEQ_NO) FROM RES_SEGMENT WITH(NOLOCK)  WHERE RES_CODE =  RMD.RES_CODE )
		LEFT JOIN RES_HTL_ROOM_MASTER RHRM WITH(NOLOCK) ON RMD.RES_CODE = RHRM.RES_CODE
		LEFT JOIN (
			SELECT RMD.RES_CODE
				, COUNT(*) AS [TOTAL_RES_COUNT]
				, SUM(CASE RCD.AGE_TYPE WHEN 0 THEN 1 END) AS [ADT_COUNT]
				, SUM(CASE RCD.AGE_TYPE WHEN 1 THEN 1 END) AS [CHD_COUNT]
				, SUM(CASE RCD.AGE_TYPE WHEN 2 THEN 1 END) AS [INT_COUNT]
			FROM RES_MASTER_damo RMD WITH(NOLOCK)
			LEFT JOIN RES_CUSTOMER_damo RCD WITH(NOLOCK) ON RMD.RES_CODE = RCD.RES_CODE
			WHERE RMD.RES_CODE IN (SELECT RES_CODE FROM COM_BIZTRIP_DETAIL CBD WITH(NOLOCK) WHERE CBD.AGT_CODE = @AGT_CODE AND CBD.BT_CODE = @BT_CODE) 
				AND RMD.RES_STATE <= 7 AND RCD.RES_STATE = 0
			GROUP BY RMD.RES_CODE
		) RCC ON RMD.RES_CODE = RCC.RES_CODE
		WHERE CBM.AGT_CODE = @AGT_CODE and CBM.BT_CODE = @BT_CODE
		ORDER BY RMD.DEP_DATE ASC 
	END

	-- 출장자 페이지이고 예약자 본인이 아닌경우 자신이 포함된 예약건만 노출
	ELSE
	BEGIN 
		SELECT CBM.AGT_CODE, CBM.BT_CODE, RMD.RES_CODE, RMD.RES_STATE, RMD.NEW_DATE, 
		CASE WHEN RMD.PRO_TYPE = 2 THEN 
		--ISNULL( (SELECT '(' +KOR_NAME +')' FROM PUB_AIRLINE WHERE AIRLINE_CODE = RS1.AIRLINE_CODE ) , '') + 
		(CASE dbo.FN_RES_AIR_GET_RTG_TYPE(RMD.RES_CODE) WHEN 1 THEN '(편도)' WHEN 2 THEN '(다구간)' ELSE '(왕복)' END ) +
		dbo.FN_RES_AIR_GET_PRO_NAME(RMD.RES_CODE)   --항공일때 항공사 + 여정표시  
			ELSE RMD.PRO_NAME END AS PRO_NAME , 
		RMD.DEP_DATE, (CASE WHEN RMD.ARR_DATE IS NULL THEN CONVERT(DATETIME,CONVERT(VARCHAR(10), RAD.DEP_ARR_DATE) + ' ' + RAD.DEP_ARR_TIME ) ELSE RMD.ARR_DATE END) AS ARR_DATE --RMD.ARR_DATE
			, RS1.AIRLINE_CODE AS [FIRST_AIRLINE_CODE], RS1.FLIGHT AS [FIRST_FLIGHT], RS2.AIRLINE_CODE AS [LAST_AIRLINE_CODE], RS2.FLIGHT AS [LAST_FLIGHT], dbo.FN_RES_AIR_GET_RTG_TYPE(RMD.RES_CODE) AS [ROUTING_TYPE]
			, (SELECT KOR_NAME FROM PUB_AIRLINE WHERE AIRLINE_CODE = RS1.AIRLINE_CODE ) AS FIRST_AIRLINE_NAME 
			, (SELECT KOR_NAME FROM PUB_AIRLINE WHERE AIRLINE_CODE = RS2.AIRLINE_CODE ) AS LAST_AIRLINE_NAME 
			, CASE WHEN RMD.PRO_TYPE = 2 THEN dbo.FN_RES_AIR_GET_PRO_NAME(RMD.RES_CODE) ELSE '' END  AS ROUTING_TEXT 
			, CASE WHEN RMD.PRO_TYPE = 2 THEN ISNULL((SELECT MAX(SEG_CNT) FROM (SELECT COUNT(*) SEG_CNT FROM RES_SEGMENT WHERE RES_CODE = RMD.RES_CODE GROUP BY DIRECTION  ) T ),0) - 1  END AS NUMBER_OF_STOP 
			, RAD.FARE_SEAT_TYPE
			, (CASE
				WHEN RAD.FARE_SEAT_TYPE = 1 THEN '일반석'
				WHEN RAD.FARE_SEAT_TYPE = 2 THEN '비즈니스'
				WHEN RAD.FARE_SEAT_TYPE = 3 THEN '일등석' END) AS [AIR_CLASS]
			, (SELECT (MAX(RHRD.ROOM_NAME) + ' ' + CONVERT(VARCHAR(10), COUNT(*)) + '개') FROM RES_HTL_ROOM_DETAIL RHRD WHERE RHRD.RES_CODE = RMD.RES_CODE GROUP BY RHRD.RES_CODE) AS [ROOM_NAME]
			, DATEDIFF(DAY, RMD.DEP_DATE, (CASE WHEN RMD.ARR_DATE IS NULL THEN CONVERT(DATETIME,CONVERT(VARCHAR(10), RAD.DEP_ARR_DATE) + ' ' + RAD.DEP_ARR_TIME ) ELSE RMD.ARR_DATE END)) AS [PRO_DAY], RMD.LAST_PAY_DATE
			, DATEDIFF(DAY, GETDATE(), RMD.LAST_PAY_DATE) AS [LIMIT_DAY]
			, (CASE
				WHEN RMD.PRO_TYPE = 2 THEN '항공'
				WHEN RMD.PRO_TYPE = 3 THEN '호텔'
				WHEN RMD.PRO_TYPE = 1 AND CBD.PRO_DETAIL_TYPE = 4 THEN '렌트카'
				WHEN RMD.PRO_TYPE = 1 AND CBD.PRO_DETAIL_TYPE = 5 THEN '비자'
				WHEN RMD.PRO_TYPE = 1 AND CBD.PRO_DETAIL_TYPE = 9 THEN '기타' END) AS [PRO_TYPE_NAME]
			, (SELECT COUNT(*) FROM COM_RECEIVE_SMS RSS WHERE RMD.RES_CODE = RSS.RES_CODE ) AS SMS_COUNT
			, (SELECT COUNT(*) FROM COM_RECEIVE_EMAIL RSE WHERE RMD.RES_CODE = RSE.RES_CODE ) AS EMAIL_COUNT
			, SUBSTRING((
				SELECT (',' + RCD.CUS_NAME + ' ' + (CASE WHEN CE.EMP_SEQ IS NULL THEN ('(외부인)') ELSE (ISNULL(CP.POS_NAME,'') + '(' + ISNULL(CT.TEAM_NAME,'') + ')') END)) AS [text()]
				FROM RES_MASTER_damo RMD2
				INNER JOIN RES_CUSTOMER_damo RCD WITH(NOLOCK) ON RMD2.RES_CODE = RCD.RES_CODE AND RCD.RES_STATE = 0
				LEFT JOIN COM_EMPLOYEE_MATCHING CEM WITH(NOLOCK) ON CEM.AGT_CODE = @AGT_CODE AND RCD.CUS_NO = CEM.CUS_NO
				LEFT JOIN COM_EMPLOYEE CE WITH(NOLOCK) ON CEM.AGT_CODE = CE.AGT_CODE and CEM.EMP_SEQ = CE.EMP_SEQ
				LEFT JOIN COM_TEAM CT WITH(NOLOCK) ON CE.AGT_CODE = CT.AGT_CODE AND CE.TEAM_SEQ = CT.TEAM_SEQ
				LEFT JOIN COM_POSITION CP WITH(NOLOCK) ON CE.AGT_CODE = CP.AGT_CODE and CE.POS_SEQ = CP.POS_SEQ
				WHERE RMD2.res_code = CBD.RES_CODE --AND RMD2.RES_STATE <= 7 AND RCD.RES_STATE = 0
				FOR XML PATH('')
			), 2, 10000) AS [CUS_LIST]
			, RCC.TOTAL_RES_COUNT, RCC.ADT_COUNT, RCC.CHD_COUNT, RCC.INT_COUNT
			, dbo.FN_RES_GET_TOTAL_PRICE(RMD.RES_CODE) AS TOTAL_SALE_PRICE
		FROM COM_BIZTRIP_MASTER CBM WITH(NOLOCK)
		INNER JOIN COM_BIZTRIP_DETAIL CBD WITH(NOLOCK) ON CBM.AGT_CODE = CBD.AGT_CODE and CBM.BT_CODE = CBD.BT_CODE
		INNER JOIN RES_MASTER_damo RMD WITH(NOLOCK) ON CBD.RES_CODE = RMD.RES_CODE
		LEFT JOIN RES_AIR_DETAIL RAD WITH(NOLOCK) ON RMD.RES_CODE = RAD.RES_CODE
		LEFT JOIN RES_SEGMENT RS1 WITH(NOLOCK) ON RAD.RES_CODE = RS1.RES_CODE AND RS1.SEQ_NO = 1
		LEFT JOIN RES_SEGMENT RS2 WITH(NOLOCK) ON RAD.RES_CODE = RS2.RES_CODE AND RS2.SEQ_NO = (SELECT MAX(SEQ_NO) FROM RES_SEGMENT WITH(NOLOCK)  WHERE RES_CODE =  RMD.RES_CODE )
		LEFT JOIN RES_HTL_ROOM_MASTER RHRM WITH(NOLOCK) ON RMD.RES_CODE = RHRM.RES_CODE
		LEFT JOIN (
			SELECT RMD.RES_CODE
				, COUNT(*) AS [TOTAL_RES_COUNT]
				, SUM(CASE RCD.AGE_TYPE WHEN 0 THEN 1 END) AS [ADT_COUNT]
				, SUM(CASE RCD.AGE_TYPE WHEN 1 THEN 1 END) AS [CHD_COUNT]
				, SUM(CASE RCD.AGE_TYPE WHEN 2 THEN 1 END) AS [INT_COUNT]
			FROM RES_MASTER_damo RMD WITH(NOLOCK)
			LEFT JOIN RES_CUSTOMER_damo RCD WITH(NOLOCK) ON RMD.RES_CODE = RCD.RES_CODE
			WHERE RMD.RES_CODE IN (SELECT RES_CODE FROM COM_BIZTRIP_DETAIL CBD WITH(NOLOCK) WHERE CBD.AGT_CODE = @AGT_CODE AND CBD.BT_CODE = @BT_CODE) 
				AND RMD.RES_STATE <= 7 AND RCD.RES_STATE = 0
			GROUP BY RMD.RES_CODE
		) RCC ON RMD.RES_CODE = RCC.RES_CODE
		WHERE CBM.AGT_CODE = @AGT_CODE and CBM.BT_CODE = @BT_CODE AND @EMP_CODE IN  (
			(SELECT CE.EMP_SEQ
			FROM RES_MASTER_damo RMD2
			INNER JOIN RES_CUSTOMER_damo RCD WITH(NOLOCK) ON RMD2.RES_CODE = RCD.RES_CODE
			LEFT JOIN COM_EMPLOYEE_MATCHING CEM WITH(NOLOCK) ON CEM.AGT_CODE = @AGT_CODE AND RCD.CUS_NO = CEM.CUS_NO
			LEFT JOIN COM_EMPLOYEE CE WITH(NOLOCK) ON CEM.AGT_CODE = CE.AGT_CODE and CEM.EMP_SEQ = CE.EMP_SEQ
			WHERE RMD2.res_code =  CBD.RES_CODE))
		ORDER BY RMD.DEP_DATE ASC 
	END

END 
GO
