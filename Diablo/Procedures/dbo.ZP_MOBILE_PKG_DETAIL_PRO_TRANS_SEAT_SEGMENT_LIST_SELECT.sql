USE [Diablo]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*================================================================================================================
■ USP_NAME					: ZP_MOBILE_PKG_DETAIL_PRO_TRANS_SEAT_SEGMENT_LIST_SELECT
■ DESCRIPTION				: 행사 항공편 경유지 리스트
■ INPUT PARAMETER			: 
	@PRO_CODE				: 행사코드
	@SEAT_CODE				: 좌석코드
■ OUTPUT PARAMETER			: 	
■ EXEC						: 

	DECLARE @PRO_CODE varchar(20)
	DECLARE @SEAT_CODE int

	--SELECT @PRO_CODE=N'EPP300-190929LH',@SEAT_CODE=8047960
	SELECT @PRO_CODE=N'EPP4223-191002LH',@SEAT_CODE=6699180

	EXECUTE ZP_MOBILE_PKG_DETAIL_PRO_TRANS_SEAT_SEGMENT_LIST_SELECT @PRO_CODE ,@SEAT_CODE

■ MEMO						: 
------------------------------------------------------------------------------------------------------------------
■ CHANGE HISTORY                   
------------------------------------------------------------------------------------------------------------------
   DATE				AUTHOR			DESCRIPTION           
------------------------------------------------------------------------------------------------------------------
   2019-09-27		최영준			최초생성
================================================================================================================*/ 

CREATE PROCEDURE [dbo].[ZP_MOBILE_PKG_DETAIL_PRO_TRANS_SEAT_SEGMENT_LIST_SELECT]
(
	@PRO_CODE		VARCHAR(20),
	@SEAT_CODE		INT
)

AS  
BEGIN

	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED	
	
	--SET @PRO_CODE = 'EPP300-190929LH'

	SELECT
		A.PRO_CODE, B.SEAT_CODE,
		B.DEP_TRANS_CODE, (SELECT KOR_NAME FROM PUB_AIRLINE AA WITH(NOLOCK) WHERE AA.AIRLINE_CODE = B.DEP_TRANS_CODE) AS [DEP_TRANS_NAME], B.DEP_TRANS_NUMBER,		
		B.DEP_DEP_AIRPORT_CODE, (SELECT DBO.FN_PUB_GET_CITY_NAME(AA.CITY_CODE) FROM PUB_AIRPORT AA WITH(NOLOCK) WHERE AA.AIRPORT_CODE = B.DEP_DEP_AIRPORT_CODE) AS [DEP_DEP_AIRPORT_NAME],
		B.DEP_ARR_AIRPORT_CODE, (SELECT DBO.FN_PUB_GET_CITY_NAME(AA.CITY_CODE) FROM PUB_AIRPORT AA WITH(NOLOCK) WHERE AA.AIRPORT_CODE = B.DEP_ARR_AIRPORT_CODE) AS [DEP_ARR_AIRPORT_NAME],		
		B.DEP_DEP_DATE, B.DEP_ARR_DATE, B.DEP_DEP_TIME, B.DEP_ARR_TIME, B.DEP_SPEND_TIME,
		B.ARR_TRANS_CODE, (SELECT KOR_NAME FROM PUB_AIRLINE AA WITH(NOLOCK) WHERE AA.AIRLINE_CODE = B.ARR_TRANS_CODE) AS [ARR_TRANS_NAME], B.ARR_TRANS_NUMBER,
		B.ARR_DEP_AIRPORT_CODE, (SELECT DBO.FN_PUB_GET_CITY_NAME(AA.CITY_CODE) FROM PUB_AIRPORT AA WITH(NOLOCK) WHERE AA.AIRPORT_CODE = B.ARR_DEP_AIRPORT_CODE) AS [ARR_DEP_AIRPORT_NAME],
		B.ARR_ARR_AIRPORT_CODE, (SELECT DBO.FN_PUB_GET_CITY_NAME(AA.CITY_CODE) FROM PUB_AIRPORT AA WITH(NOLOCK) WHERE AA.AIRPORT_CODE = B.ARR_ARR_AIRPORT_CODE) AS [ARR_ARR_AIRPORT_NAME],
		B.ARR_DEP_DATE, B.ARR_ARR_DATE, B.ARR_DEP_TIME, B.ARR_ARR_TIME, B.ARR_SPEND_TIME
	FROM
		PKG_DETAIL A WITH (NOLOCK) 
		INNER JOIN PRO_TRANS_SEAT B WITH(NOLOCK) ON A.SEAT_CODE = B.SEAT_CODE	
	WHERE
		A.PRO_CODE = @PRO_CODE AND B.SEAT_CODE = @SEAT_CODE
		--A.PRO_CODE = 'EPP300-190929LH' AND B.SEAT_CODE = @SEAT_CODE

	SELECT
		AA.PRO_CODE, BB.SEAT_CODE,
		BB.TRANS_SEQ, BB.SEG_NO,
		BB.AIRLINE_CODE, (SELECT KOR_NAME FROM PUB_AIRLINE A WITH(NOLOCK) WHERE A.AIRLINE_CODE = BB.AIRLINE_CODE) AS [AIRLINE_NAME],
		BB.FLIGHT,		
		BB.DEP_AIRPORT_CODE, (SELECT DBO.FN_PUB_GET_CITY_NAME(A.CITY_CODE) FROM PUB_AIRPORT A WITH(NOLOCK) WHERE A.AIRPORT_CODE = BB.DEP_AIRPORT_CODE) AS [DEP_AIRPORT_NAME],
		BB.ARR_AIRPORT_CODE, (SELECT DBO.FN_PUB_GET_CITY_NAME(A.CITY_CODE) FROM PUB_AIRPORT A WITH(NOLOCK) WHERE A.AIRPORT_CODE = BB.ARR_AIRPORT_CODE) AS [ARR_AIRPORT_NAME],	
		BB.DEP_DATE, BB.ARR_DATE, BB.FLYING_TIME, BB.REAL_AIRLINE_CODE,
		ISNULL((SELECT KOR_NAME FROM PUB_AIRLINE A WITH(NOLOCK) WHERE A.AIRLINE_CODE = BB.REAL_AIRLINE_CODE), '') AS [REAL_AIRLINE__NAME]
	FROM
	(
		SELECT
			A.PRO_CODE, B.SEAT_CODE
		FROM
			PKG_DETAIL A WITH (NOLOCK) 
			INNER JOIN PRO_TRANS_SEAT B WITH(NOLOCK) ON A.SEAT_CODE = B.SEAT_CODE
		WHERE
			A.PRO_CODE = @PRO_CODE AND B.SEAT_CODE = @SEAT_CODE
			--A.PRO_CODE = 'EPP300-190929LH' AND B.SEAT_CODE = @SEAT_CODE
	) AA
	INNER JOIN 
	(
		SELECT 
			SEAT_CODE, TRANS_SEQ, SEG_NO, DEP_AIRPORT_CODE, ARR_AIRPORT_CODE, AIRLINE_CODE, FLIGHT, DEP_DATE, ARR_DATE, FLYING_TIME, REAL_AIRLINE_CODE
		FROM
			PRO_TRANS_SEAT_SEGMENT C WITH(NOLOCK)
		WHERE
			SEAT_CODE = @SEAT_CODE
	) BB
	ON AA.SEAT_CODE = BB.SEAT_CODE
	
END
GO
