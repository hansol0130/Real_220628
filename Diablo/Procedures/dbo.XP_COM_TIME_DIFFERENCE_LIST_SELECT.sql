USE [Diablo]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*================================================================================================================
■ USP_NAME					: XP_COM_TIME_DIFFERENCE_LIST_SELECT
■ DESCRIPTION				: BTMS 시차정보 지역별시차
■ INPUT PARAMETER			: 
	@W_REGION_KOR_NAME VARCHAR(300) :  
■ OUTPUT PARAMETER			: 
■ EXEC						: 

	EXEC XP_COM_TIME_DIFFERENCE_LIST_SELECT '유럽'

■ MEMO						: 
------------------------------------------------------------------------------------------------------------------
■ CHANGE HISTORY
------------------------------------------------------------------------------------------------------------------
   DATE				AUTHOR			DESCRIPTION           
------------------------------------------------------------------------------------------------------------------
   2016-01-26		이유라			최초생성
   2016-05-27		김성호			INFO_USE_YN 컬럼 사용 안하는쪽으로 수정
================================================================================================================*/ 
CREATE PROC [dbo].[XP_COM_TIME_DIFFERENCE_LIST_SELECT]
(
	@W_REGION_KOR_NAME		VARCHAR(300)
)
	
AS 
BEGIN

	DECLARE @USE_CITY_CODE VARCHAR(700) = '10381,11035,12375,12843,1492,15614,16239,16716,2484,27612,2974,35188,3770,38457,40080,40100,40180,40183,40270,40438,40582,40745,40754,41170,41194,41217,41404,41480,41780,41923,42182,43466,43555,44292,44454,45007,46001,47108,47662,47772,48454,48647,48698,48820,48991,54511,58362,59287,59358,60155,60369,60419,61641,6181,62010,62318,62366,6240,62405,63820,63870,63980,65201,65472,65660,6631,68368,68816,70273,71063,71430,7149,71508,71628,71892,72205,72243,72295,72334,72408,72434,72493,72494,72503,72524,72530,72537,72551,72572,72764,72793,76680,78460,80222,8221,83378,83746,83780,84071,85574,8579,86218,87582,91182,93110,93781,93831,94287,94578,94610,94767,94866,96745,98425'

	-- 검색_시차정보_지역별시차 --
	SELECT 
		RANK() OVER(ORDER BY W_NATION_KOR_NAME,W_CITY_KOR_NAME ) AS SORT_NUM,
		W_CITY_CODE,
		W_CITY_ENG_NAME,
		W_CITY_KOR_NAME,
		W_NATION_CODE,
		W_NATION_KOR_NAME,
		W_NATION_ENG_NAME,
		W_REGION_KOR_NAME,
		W_REGION_ENG_NAME,
		LATITUDE,
		LONGITUDE,
		ISNULL((
			SELECT TOP 1 CONVERT(FLOAT, UTC)+1 
			FROM WEATHERI_CITY_MAP_2 B WITH(NOLOCK)
			WHERE B.W_CITY_CODE IN (SELECT Data FROM dbo.FN_SPLIT(@USE_CITY_CODE, ','))
				AND GETDATE() BETWEEN B.SUMMER_TIME_START AND B.SUMMER_TIME_END AND A.W_CITY_CODE = B.W_CITY_CODE AND B.CITY_CODE IS NOT NULL
		), UTC) AS UTC,
		SUMMER_TIME_START,
		SUMMER_TIME_END,
		CITY_CODE,
		NATION_CODE,
		REMARK,
		W_CITY_CODE_OLD
	FROM WEATHERI_CITY_MAP_2 A WITH(NOLOCK)
	--WHERE CITY_CODE IS NOT NULL AND INFO_USE_YN = 'Y' AND A.W_REGION_KOR_NAME = @W_REGION_KOR_NAME
	WHERE A.W_CITY_CODE IN (SELECT Data FROM dbo.FN_SPLIT(@USE_CITY_CODE, ','))
		AND A.W_REGION_KOR_NAME = @W_REGION_KOR_NAME AND A.CITY_CODE IS NOT NULL
	ORDER BY W_NATION_KOR_NAME, W_CITY_KOR_NAME

END 
GO
