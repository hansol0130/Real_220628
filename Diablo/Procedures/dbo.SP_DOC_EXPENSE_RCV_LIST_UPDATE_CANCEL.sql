USE [Diablo]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[SP_DOC_EXPENSE_RCV_LIST_UPDATE_CANCEL]
	@EDI_CODE_LIST	VARCHAR(8000),
	@RCV_CODE		CHAR(7)
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE @QUERY VARCHAR(8000), @NOW VARCHAR(20)--, @EMP_LIST VARCHAR(100)
	
	SET @NOW = CONVERT(VARCHAR(20), GETDATE(), 120)

	SET @QUERY = '
	UPDATE EDI_MASTER_DAMO SET
		RCV_CODE = NULL,	RCV_YN = ''N'',
		RCV_REMARK = ''[처리취소 : ' + @NOW + ']'',	RCV_DATE = NULL
	WHERE EDI_CODE IN (' + @EDI_CODE_LIST + ')'

	EXEC (@QUERY)
	--PRINT (@QUERY)

	SET @QUERY = '
	DECLARE @EMP_LIST VARCHAR(100)
	SELECT @EMP_LIST = STUFF((SELECT '','' + NEW_CODE AS [text()] 
	FROM EDI_MASTER_DAMO WHERE EDI_CODE IN (' + @EDI_CODE_LIST + ') FOR XML PATH('''') ), 1, 1, '''')

	EXEC SP_NOTE_INSERT @EMP_LIST, 0, '''', '''', ''[전자결재] 처리가 취소되었습니다.'', ''[전자결재] 처리가 취소되었습니다.'', ''' + @RCV_CODE + ''''

	EXEC (@QUERY)
	--PRINT (@QUERY)

	-- 쪽지발송
--	EXEC SP_NOTE_INSERT 받는사람코드 (2008011), 0, '', '', 내용, 제목, 보낸사람코드

END
GO
